 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyrhythmicTriadGen v4.0 - All-in-One</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            color: #adbce6;
            font-size: 1.1em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: #ffd700;
            font-size: 1.3em;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #adbce6;
            font-size: 0.9em;
        }
        
        select, input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        
        select option {
            background: #2a5298;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1e3c72;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }
        
        .rhythm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .rhythm-cell {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        
        .voice-label {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .tuplet-display {
            font-size: 1.5em;
            margin: 10px 0;
        }
        
        #visualizer {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .beat-indicator {
            position: absolute;
            width: 2px;
            height: 100%;
            background: rgba(255,215,0,0.5);
            animation: moveBeats 4s linear infinite;
        }
        
        @keyframes moveBeats {
            from { left: 0; }
            to { left: 100%; }
        }
        
        .voice-track {
            height: 60px;
            margin: 10px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        
        .note-event {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.6), transparent);
            width: 20px;
            border-radius: 3px;
        }
        
        .complexity-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #adbce6;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .preset-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px;
            font-size: 0.9em;
        }
        
        .preset-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
        }
        
        .output-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .code-output {
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .analysis-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .analysis-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
        }
        
        .analysis-label {
            color: #adbce6;
            font-size: 0.8em;
        }
        
        .analysis-value {
            font-size: 1.2em;
            color: #ffd700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PolyrhythmicTriadGen v4.0</h1>
            <div class="subtitle">Advanced Polyrhythmic Triad Generation with Polytonal Support</div>
        </header>
        
        <div class="main-grid">
            <!-- Left Panel: Triad Controls -->
            <div class="panel">
                <h2>Triad Configuration</h2>
                
                <div class="control-group">
                    <label>Root Note</label>
                    <select id="rootNote">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D" selected>D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Triad Quality</label>
                    <select id="quality">
                        <option value="major" selected>Major</option>
                        <option value="minor">Minor</option>
                        <option value="diminished">Diminished</option>
                        <option value="augmented">Augmented</option>
                        <option value="suspended2">Sus2</option>
                        <option value="suspended4">Sus4</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Tonal System</label>
                    <select id="tonalSystem">
                        <option value="chromatic" selected>Chromatic</option>
                        <option value="diatonic">Diatonic</option>
                        <option value="whole-tone">Whole Tone</option>
                        <option value="octatonic">Octatonic</option>
                        <option value="hexatonic">Hexatonic</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="polytonal"> Enable Polytonal Layers
                    </label>
                </div>
                
                <div class="control-group">
                    <label>Ensemble Type</label>
                    <select id="ensemble">
                        <option value="solo">Solo</option>
                        <option value="quartet">String Quartet</option>
                        <option value="quintet" selected>String Quintet (with Guitar)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Rhythmic Complexity</label>
                    <input type="range" id="complexity" min="1" max="10" value="5" class="complexity-slider">
                    <div class="slider-labels">
                        <span>Simple</span>
                        <span>Complex</span>
                    </div>
                    <div style="text-align: center; color: #ffd700;">
                        Level: <span id="complexityValue">5</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Presets</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadPreset('Minimalist')">Minimalist</button>
                        <button class="preset-btn" onclick="loadPreset('Jazz Fusion')">Jazz Fusion</button>
                        <button class="preset-btn" onclick="loadPreset('Progressive')">Progressive</button>
                        <button class="preset-btn" onclick="loadPreset('Complex Contemporary')">Contemporary</button>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="generatePattern()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                        GENERATE PATTERN
                    </button>
                </div>
            </div>
            
            <!-- Center Panel: Visualization -->
            <div class="panel">
                <h2>Polyrhythmic Visualization</h2>
                <div id="visualizer">
                    <div class="beat-indicator"></div>
                    <div id="voiceTracks"></div>
                </div>
                
                <div class="rhythm-grid" id="rhythmGrid">
                    <!-- Rhythm assignments will be displayed here -->
                </div>
                
                <div class="output-section">
                    <h3 style="margin-bottom: 10px;">Pattern Analysis</h3>
                    <div class="analysis-display" id="analysisDisplay">
                        <!-- Analysis results here -->
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Output & Export -->
            <div class="panel">
                <h2>Output & Integration</h2>
                
                <div class="control-group">
                    <label>Target Application</label>
                    <select id="targetApp">
                        <option value="standalone">Standalone</option>
                        <option value="quartet-engine">Quartet Engine</option>
                        <option value="quintet-composer">Quintet Composer</option>
                        <option value="gcc">Generative Chamber Composer</option>
                    </select>
                </div>
                
                <div style="margin: 15px 0;">
                    <button onclick="exportMusicXML()">Export MusicXML (Sibelius)</button>
                    <button onclick="exportJSON()">Export JSON</button>
                    <button onclick="sendToTarget()">Send to Target</button>
                </div>
                
                <div class="output-section">
                    <h3>Current Pattern Data</h3>
                    <div class="code-output" id="patternOutput">
                        <pre>No pattern generated yet</pre>
                    </div>
                </div>
                
                <div class="output-section">
                    <h3>Voice Assignments</h3>
                    <div id="voiceAssignments" class="code-output">
                        <!-- Voice-specific data here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // =====================================================
        // COMPLETE POLYRHYTHMIC ENGINE - ALL IN ONE FILE
        // =====================================================
        
        // Current pattern storage
        let currentPattern = null;
        
        // Tuplet library with complexity ratings
        const tupletLibrary = {
            simple: {
                "2:3": { num: 2, denom: 3, complexity: 1 },
                "3:2": { num: 3, denom: 2, complexity: 1 },
                "4:3": { num: 4, denom: 3, complexity: 2 },
                "3:4": { num: 3, denom: 4, complexity: 2 }
            },
            intermediate: {
                "5:4": { num: 5, denom: 4, complexity: 3 },
                "4:5": { num: 4, denom: 5, complexity: 3 },
                "5:3": { num: 5, denom: 3, complexity: 4 },
                "6:5": { num: 6, denom: 5, complexity: 4 },
                "7:4": { num: 7, denom: 4, complexity: 5 },
                "7:6": { num: 7, denom: 6, complexity: 5 },
                "6:4": { num: 6, denom: 4, complexity: 3 }
            },
            complex: {
                "8:5": { num: 8, denom: 5, complexity: 6 },
                "9:8": { num: 9, denom: 8, complexity: 6 },
                "11:8": { num: 11, denom: 8, complexity: 7 },
                "13:8": { num: 13, denom: 8, complexity: 8 },
                "15:8": { num: 15, denom: 8, complexity: 9 },
                "17:16": { num: 17, denom: 16, complexity: 10 }
            }
        };
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Update complexity display
            document.getElementById('complexity').addEventListener('input', function(e) {
                document.getElementById('complexityValue').textContent = e.target.value;
            });
        });
        
        // Generate the complete pattern
        function generatePattern() {
            const params = {
                root: document.getElementById('rootNote').value,
                quality: document.getElementById('quality').value,
                tonalSystem: document.getElementById('tonalSystem').value,
                ensemble: document.getElementById('ensemble').value,
                complexity: parseInt(document.getElementById('complexity').value),
                polytonal: document.getElementById('polytonal').checked
            };
            
            // Generate triad
            const triad = generateTriad(params.root, params.quality);
            
            // Generate polyrhythmic pattern
            currentPattern = generatePolyrhythmicPattern(triad, params);
            
            // Update all displays
            updateVisualization();
            updateRhythmGrid();
            updateAnalysis();
            updatePatternOutput();
        }
        
        // Generate base triad
        function generateTriad(root, quality) {
            const intervals = {
                major: [0, 4, 7],
                minor: [0, 3, 7],
                diminished: [0, 3, 6],
                augmented: [0, 4, 8],
                suspended2: [0, 2, 7],
                suspended4: [0, 5, 7]
            };
            
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const rootIndex = notes.indexOf(root);
            const pattern = intervals[quality] || intervals.major;
            
            return {
                root: root,
                third: notes[(rootIndex + pattern[1]) % 12],
                fifth: notes[(rootIndex + pattern[2]) % 12],
                quality: quality
            };
        }
        
        // Generate polyrhythmic pattern
        function generatePolyrhythmicPattern(triad, params) {
            const ensembles = {
                solo: ["primary"],
                quartet: ["violin1", "violin2", "viola", "cello"],
                quintet: ["guitar", "violin1", "violin2", "viola", "cello"]
            };
            
            const voices = ensembles[params.ensemble];
            const availableRatios = getAvailableRatios(params.complexity);
            
            const pattern = {
                triad: triad,
                voices: {},
                complexity: params.complexity,
                measureLength: 4,
                beatUnit: 4,
                timestamp: Date.now()
            };
            
            // Assign unique rhythms to each voice
            voices.forEach((voice, index) => {
                const ratio = availableRatios[index % availableRatios.length];
                pattern.voices[voice] = {
                    tupletRatio: `${ratio.num}:${ratio.denom}`,
                    dynamic: ["ff", "f", "mf", "mp", "p"][index],
                    notePattern: distributeTriadNotes(triad, ratio),
                    accentPattern: generateAccentPattern(ratio.num)
                };
            });
            
            return pattern;
        }
        
        // Get available ratios based on complexity
        function getAvailableRatios(complexity) {
            const ratios = [];
            
            if (complexity <= 3) {
                ratios.push(...Object.values(tupletLibrary.simple));
            }
            if (complexity > 3 && complexity <= 6) {
                ratios.push(...Object.values(tupletLibrary.simple));
                ratios.push(...Object.values(tupletLibrary.intermediate));
            }
            if (complexity > 6) {
                ratios.push(...Object.values(tupletLibrary.intermediate));
                ratios.push(...Object.values(tupletLibrary.complex));
            }
            
            // Sort by complexity and return unique ratios
            return ratios.sort((a, b) => a.complexity - b.complexity);
        }
        
        // Distribute triad notes across rhythm
        function distributeTriadNotes(triad, ratio) {
            const notes = [triad.root, triad.third, triad.fifth];
            const pattern = [];
            
            for (let i = 0; i < ratio.num; i++) {
                const noteChoice = notes[i % 3];
                const octave = 4 + Math.floor(i / 6); // Shift octave every 6 notes
                pattern.push({
                    pitch: noteChoice,
                    octave: octave,
                    duration: ratio.denom / ratio.num,
                    position: i / ratio.num
                });
            }
            
            return pattern;
        }
        
        // Generate accent pattern
        function generateAccentPattern(numNotes) {
            const pattern = [];
            for (let i = 0; i < numNotes; i++) {
                if (i === 0) pattern.push(3); // Strong accent
                else if (i % 3 === 0) pattern.push(2); // Medium accent
                else pattern.push(1); // Weak accent
            }
            return pattern;
        }
        
        // Update visualization
        function updateVisualization() {
            const tracks = document.getElementById('voiceTracks');
            tracks.innerHTML = '';
            
            if (!currentPattern) return;
            
            Object.entries(currentPattern.voices).forEach(([voice, data]) => {
                const track = document.createElement('div');
                track.className = 'voice-track';
                track.innerHTML = `
                    <div style="position: absolute; left: 10px; top: 20px; color: #ffd700;">
                        ${voice}: ${data.tupletRatio}
                    </div>
                `;
                
                // Add note events based on tuplet ratio
                const [num] = data.tupletRatio.split(':').map(Number);
                for (let i = 0; i < num; i++) {
                    const note = document.createElement('div');
                    note.className = 'note-event';
                    note.style.left = `${(i / num) * 100}%`;
                    track.appendChild(note);
                }
                
                tracks.appendChild(track);
            });
        }
        
        // Update rhythm grid
        function updateRhythmGrid() {
            const grid = document.getElementById('rhythmGrid');
            grid.innerHTML = '';
            
            if (!currentPattern) return;
            
            Object.entries(currentPattern.voices).forEach(([voice, data]) => {
                const cell = document.createElement('div');
                cell.className = 'rhythm-cell';
                cell.innerHTML = `
                    <div class="voice-label">${voice}</div>
                    <div class="tuplet-display">${data.tupletRatio}</div>
                    <div style="font-size: 0.9em; color: #adbce6;">${data.dynamic}</div>
                `;
                grid.appendChild(cell);
            });
        }
        
        // Update analysis display
        function updateAnalysis() {
            const display = document.getElementById('analysisDisplay');
            
            if (!currentPattern) {
                display.innerHTML = '<div>No pattern to analyze</div>';
                return;
            }
            
            const voiceCount = Object.keys(currentPattern.voices).length;
            const uniqueRatios = new Set(Object.values(currentPattern.voices).map(v => v.tupletRatio)).size;
            
            display.innerHTML = `
                <div class="analysis-item">
                    <div class="analysis-label">Voice Count</div>
                    <div class="analysis-value">${voiceCount}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Unique Rhythms</div>
                    <div class="analysis-value">${uniqueRatios}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Complexity Level</div>
                    <div class="analysis-value">${currentPattern.complexity}/10</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Polytonal</div>
                    <div class="analysis-value">${document.getElementById('polytonal').checked ? 'Yes' : 'No'}</div>
                </div>
            `;
        }
        
        // Update pattern output display
        function updatePatternOutput() {
            const output = document.getElementById('patternOutput');
            const voiceOutput = document.getElementById('voiceAssignments');
            
            if (!currentPattern) {
                output.innerHTML = '<pre>No pattern generated yet</pre>';
                return;
            }
            
            // Show JSON data
            output.innerHTML = `<pre>${JSON.stringify(currentPattern, null, 2)}</pre>`;
            
            // Show voice assignments
            let voiceText = '';
            Object.entries(currentPattern.voices).forEach(([voice, data]) => {
                voiceText += `${voice.toUpperCase()}\n`;
                voiceText += `  Ratio: ${data.tupletRatio}\n`;
                voiceText += `  Dynamic: ${data.dynamic}\n\n`;
            });
            voiceOutput.innerHTML = `<pre>${voiceText}</pre>`;
        }
        
        // Load preset configurations
        function loadPreset(presetName) {
            const presets = {
                'Minimalist': { complexity: 3, ensemble: 'quartet' },
                'Jazz Fusion': { complexity: 6, ensemble: 'quintet' },
                'Progressive': { complexity: 7, ensemble: 'quintet' },
                'Complex Contemporary': { complexity: 8, ensemble: 'quintet' }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('complexity').value = preset.complexity;
                document.getElementById('complexityValue').textContent = preset.complexity;
                document.getElementById('ensemble').value = preset.ensemble;
                
                // Update active preset button
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }
        
        // Export to Sibelius-compliant MusicXML
        function exportMusicXML() {
            if (!currentPattern) {
                alert('Please generate a pattern first');
                return;
            }
            
            const xmlContent = generateSibeliusMusicXML(currentPattern);
            const blob = new Blob([xmlContent], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `polyrhythmic-${currentPattern.triad.root}-${currentPattern.triad.quality}.musicxml`;
            a.click();
        }
        
        // Generate Sibelius-compliant MusicXML
        function generateSibeliusMusicXML(pattern) {
            const title = `Polyrhythmic Pattern - ${pattern.triad.root} ${pattern.triad.quality}`;
            const tempo = 100;
            
            let xml = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.0">
  <work>
    <work-title>${title}</work-title>
  </work>
  <identification>
    <encoding>
      <software>PolyrhythmicTriadGen v4.0</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
      <supports element="accidental" type="yes"/>
      <supports element="beam" type="yes"/>
      <supports element="stem" type="yes"/>
    </encoding>
  </identification>
  <defaults>
    <scaling>
      <millimeters>7.05556</millimeters>
      <tenths>40</tenths>
    </scaling>
  </defaults>
  <part-list>\n`;
            
            // Add part list
            let partIndex = 1;
            for (const voice of Object.keys(pattern.voices)) {
                const instrumentName = getInstrumentName(voice);
                xml += `    <score-part id="P${partIndex}">
      <part-name>${instrumentName}</part-name>
    </score-part>\n`;
                partIndex++;
            }
            
            xml += `  </part-list>\n`;
            
            // Add parts with notes
            partIndex = 1;
            for (const [voice, data] of Object.entries(pattern.voices)) {
                xml += generatePart(voice, data, partIndex, pattern, tempo);
                partIndex++;
            }
            
            xml += '</score-partwise>';
            return xml;
        }
        
        // Generate individual part
        function generatePart(voice, voiceData, partIndex, pattern, tempo) {
            const [num, denom] = voiceData.tupletRatio.split(':').map(Number);
            const clef = getClef(voice);
            
            let xml = `  <part id="P${partIndex}">
    <measure number="1">
      <attributes>
        <divisions>256</divisions>
        <key>
          <fifths>0</fifths>
        </key>
        <time>
          <beats>4</beats>
          <beat-type>4</beat-type>
        </time>
        <clef>
          <sign>${clef.sign}</sign>
          <line>${clef.line}</line>
        </clef>
      </attributes>\n`;
            
            // Add tempo for first part
            if (partIndex === 1) {
                xml += `      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
      </direction>\n`;
            }
            
            // Add dynamics
            xml += `      <direction placement="below">
        <direction-type>
          <dynamics>
            <${voiceData.dynamic}/>
          </dynamics>
        </direction-type>
      </direction>\n`;
            
            // Generate notes with proper tuplet notation
            const duration = Math.floor(1024 / num);
            
            for (let i = 0; i < voiceData.notePattern.length; i++) {
                const note = voiceData.notePattern[i];
                const pitch = getPitchInfo(note.pitch);
                
                xml += `      <note>
        <pitch>
          <step>${pitch.step}</step>${pitch.alter ? `
          <alter>${pitch.alter}</alter>` : ''}
          <octave>${note.octave}</octave>
        </pitch>
        <duration>${duration}</duration>
        <voice>1</voice>
        <type>16th</type>
        <time-modification>
          <actual-notes>${num}</actual-notes>
          <normal-notes>${denom}</normal-notes>
        </time-modification>\n`;
                
                // Add beam
                if (num > 2) {
                    if (i === 0) {
                        xml += '        <beam number="1">begin</beam>\n';
                    } else if (i === voiceData.notePattern.length - 1) {
                        xml += '        <beam number="1">end</beam>\n';
                    } else {
                        xml += '        <beam number="1">continue</beam>\n';
                    }
                }
                
                // Add notations
                if (i === 0 || i === voiceData.notePattern.length - 1) {
                    xml += '        <notations>\n';
                    if (i === 0) {
                        xml += '          <tuplet type="start" bracket="yes" number="1"/>\n';
                    } else {
                        xml += '          <tuplet type="stop" number="1"/>\n';
                    }
                    xml += '        </notations>\n';
                }
                
                xml += '      </note>\n';
            }
            
            xml += '    </measure>\n  </part>\n';
            return xml;
        }
        
        // Helper functions
        function getInstrumentName(voice) {
            const names = {
                'guitar': 'Jazz Guitar',
                'violin1': 'Violin I',
                'violin2': 'Violin II',
                'viola': 'Viola',
                'cello': 'Violoncello',
                'primary': 'Solo'
            };
            return names[voice] || voice;
        }
        
        function getClef(voice) {
            const clefs = {
                'guitar': { sign: 'G', line: 2 },
                'violin1': { sign: 'G', line: 2 },
                'violin2': { sign: 'G', line: 2 },
                'viola': { sign: 'C', line: 3 },
                'cello': { sign: 'F', line: 4 },
                'primary': { sign: 'G', line: 2 }
            };
            return clefs[voice] || { sign: 'G', line: 2 };
        }
        
        function getPitchInfo(noteName) {
            let step = noteName.replace('#', '').replace('b', '');
            let alter = 0;
            
            if (noteName.includes('#')) {
                alter = 1;
            } else if (noteName.includes('b')) {
                alter = -1;
            }
            
            return { step, alter: alter !== 0 ? alter : null };
        }
        
        // Export JSON
        function exportJSON() {
            if (!currentPattern) {
                alert('Please generate a pattern first');
                return;
            }
            
            const blob = new Blob([JSON.stringify(currentPattern, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'polyrhythmic-pattern.json';
            a.click();
        }
        
        // Send to target application
        function sendToTarget() {
            const target = document.getElementById('targetApp').value;
            if (!currentPattern) {
                alert('Please generate a pattern first');
                return;
            }
            
            console.log(`Pattern ready for ${target}:`, currentPattern);
            alert(`Pattern is ready to send to ${target}. In production, this would save to the appropriate folder.`);
        }
    </script>
</body>
</html>