<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyrhythmicTriadGen v7.0 - Professional Edition</title>
    <style>
        /* V4.0's BEAUTIFUL INTERFACE PRESERVED */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            color: #adbce6;
            font-size: 1.1em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: #ffd700;
            font-size: 1.3em;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #adbce6;
            font-size: 0.9em;
        }
        
        select, input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        
        select option {
            background: #2a5298;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1e3c72;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }
        
        .rhythm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .rhythm-cell {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        
        .voice-label {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .tuplet-display {
            font-size: 1.5em;
            margin: 10px 0;
        }
        
        #visualizer {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .beat-indicator {
            position: absolute;
            width: 2px;
            height: 100%;
            background: rgba(255,215,0,0.5);
            animation: moveBeats 4s linear infinite;
        }
        
        @keyframes moveBeats {
            from { left: 0; }
            to { left: 100%; }
        }
        
        .voice-track {
            height: 60px;
            margin: 10px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        
        .note-event {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.6), transparent);
            width: 20px;
            border-radius: 3px;
        }
        
        .complexity-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #adbce6;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .preset-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px;
            font-size: 0.9em;
        }
        
        .preset-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
        }
        
        .output-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .code-output {
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .analysis-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .analysis-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
        }
        
        .analysis-label {
            color: #adbce6;
            font-size: 0.8em;
        }
        
        .analysis-value {
            font-size: 1.2em;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Extra controls section */
        .advanced-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .measure-control {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PolyrhythmicTriadGen v7.0</h1>
            <div class="subtitle">Professional Polyrhythmic Triad Generation with Perfect Sibelius Export</div>
        </header>
        
        <div class="main-grid">
            <!-- Left Panel: Triad Controls (V4.0 Style) -->
            <div class="panel">
                <h2>Triad Configuration</h2>
                
                <div class="control-group">
                    <label>Root Note</label>
                    <select id="rootNote">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D" selected>D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Triad Quality</label>
                    <select id="quality">
                        <option value="major" selected>Major</option>
                        <option value="minor">Minor</option>
                        <option value="diminished">Diminished</option>
                        <option value="augmented">Augmented</option>
                        <option value="suspended2">Sus2</option>
                        <option value="suspended4">Sus4</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Tonal System</label>
                    <select id="tonalSystem">
                        <option value="chromatic" selected>Chromatic</option>
                        <option value="diatonic">Diatonic</option>
                        <option value="whole-tone">Whole Tone</option>
                        <option value="octatonic">Octatonic</option>
                        <option value="hexatonic">Hexatonic</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="polytonal"> Enable Polytonal Layers
                    </label>
                </div>
                
                <div class="control-group">
                    <label>Ensemble Type</label>
                    <select id="ensemble">
                        <option value="solo">Solo</option>
                        <option value="quartet">String Quartet</option>
                        <option value="quintet" selected>String Quintet (with Guitar)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Rhythmic Complexity</label>
                    <input type="range" id="complexity" min="1" max="10" value="5" class="complexity-slider">
                    <div class="slider-labels">
                        <span>Simple</span>
                        <span>Complex</span>
                    </div>
                    <div style="text-align: center; color: #ffd700;">
                        Level: <span id="complexityValue">5</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Presets</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadPreset('Minimalist')">Minimalist</button>
                        <button class="preset-btn" onclick="loadPreset('Jazz Fusion')">Jazz Fusion</button>
                        <button class="preset-btn" onclick="loadPreset('Progressive')">Progressive</button>
                        <button class="preset-btn" onclick="loadPreset('Complex Contemporary')">Contemporary</button>
                    </div>
                </div>
                
                <div class="advanced-controls">
                    <h3 style="color: #ffd700; margin-bottom: 10px;">Composition Settings</h3>
                    <div class="measure-control">
                        <div>
                            <label>Measures</label>
                            <input type="number" id="totalMeasures" min="1" max="32" value="1">
                        </div>
                        <div>
                            <label>Tempo</label>
                            <input type="number" id="tempo" min="60" max="180" value="100">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="generatePattern()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                        GENERATE PATTERN
                    </button>
                </div>
            </div>
            
            <!-- Center Panel: Visualization (V4.0 Style with Beat Indicator) -->
            <div class="panel">
                <h2>Polyrhythmic Visualization</h2>
                <div id="visualizer">
                    <div class="beat-indicator"></div>
                    <div id="voiceTracks"></div>
                </div>
                
                <div class="rhythm-grid" id="rhythmGrid">
                    <!-- Rhythm assignments will be displayed here -->
                </div>
                
                <div class="output-section">
                    <h3 style="margin-bottom: 10px;">Pattern Analysis</h3>
                    <div class="analysis-display" id="analysisDisplay">
                        <!-- Analysis results here -->
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Output & Export (V4.0 Style) -->
            <div class="panel">
                <h2>Output & Integration</h2>
                
                <div class="control-group">
                    <label>Target Application</label>
                    <select id="targetApp">
                        <option value="standalone">Standalone</option>
                        <option value="quartet-engine">Quartet Engine</option>
                        <option value="quintet-composer">Quintet Composer</option>
                        <option value="gcc">Generative Chamber Composer</option>
                    </select>
                </div>
                
                <div style="margin: 15px 0;">
                    <button onclick="exportMusicXML()">Export MusicXML (Sibelius)</button>
                    <button onclick="exportJSON()">Export JSON</button>
                    <button onclick="sendToTarget()">Send to Target</button>
                </div>
                
                <div class="output-section">
                    <h3>Current Pattern Data</h3>
                    <div class="code-output" id="patternOutput">
                        <pre>No pattern generated yet</pre>
                    </div>
                </div>
                
                <div class="output-section">
                    <h3>Voice Assignments</h3>
                    <div id="voiceAssignments" class="code-output">
                        <!-- Voice-specific data here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // =====================================================
        // POLYRHYTHMIC ENGINE v7.0 - FIXED & WORKING
        // =====================================================
        
        // Current pattern storage
        let currentPattern = null;
        
        // Tuplet ratios that actually work in Sibelius
        const tupletRatios = {
            "2:3": { num: 2, denom: 3, baseDuration: 384 },  // 2 in the time of 3
            "3:2": { num: 3, denom: 2, baseDuration: 170 },  // triplet
            "4:3": { num: 4, denom: 3, baseDuration: 192 },  // 4 over 3
            "4:5": { num: 4, denom: 5, baseDuration: 320 },  // 4 in time of 5
            "5:4": { num: 5, denom: 4, baseDuration: 204 },  // quintuplet
            "5:3": { num: 5, denom: 3, baseDuration: 153 },  // 5 over 3  
            "6:4": { num: 6, denom: 4, baseDuration: 170 },  // sextuplet
            "6:5": { num: 6, denom: 5, baseDuration: 213 },  // 6 over 5
            "7:4": { num: 7, denom: 4, baseDuration: 146 },  // septuplet
            "7:6": { num: 7, denom: 6, baseDuration: 219 },  // 7 over 6
            "8:5": { num: 8, denom: 5, baseDuration: 160 },  // 8 over 5
            "9:8": { num: 9, denom: 8, baseDuration: 227 },  // 9 over 8
            "11:8": { num: 11, denom: 8, baseDuration: 186 }, // 11 over 8
            "13:8": { num: 13, denom: 8, baseDuration: 157 }  // 13 over 8
        };
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Update complexity display
            document.getElementById('complexity').addEventListener('input', function(e) {
                document.getElementById('complexityValue').textContent = e.target.value;
            });
        });
        
        // Generate pattern with CORRECT calculations
        function generatePattern() {
            const params = {
                root: document.getElementById('rootNote').value,
                quality: document.getElementById('quality').value,
                tonalSystem: document.getElementById('tonalSystem').value,
                ensemble: document.getElementById('ensemble').value,
                complexity: parseInt(document.getElementById('complexity').value),
                polytonal: document.getElementById('polytonal').checked,
                measures: parseInt(document.getElementById('totalMeasures').value),
                tempo: parseInt(document.getElementById('tempo').value)
            };
            
            // Generate pattern with proper structure
            currentPattern = generateCorrectPattern(params);
            
            // Update displays
            updateVisualization();
            updateRhythmGrid();
            updateAnalysis();
            updatePatternOutput();
        }
        
        // FIXED: Generate pattern with correct durations
        function generateCorrectPattern(params) {
            const ensembles = {
                solo: ["primary"],
                quartet: ["violin1", "violin2", "viola", "cello"],
                quintet: ["guitar", "violin1", "violin2", "viola", "cello"]
            };
            
            const voices = ensembles[params.ensemble];
            const ratios = getComplexityRatios(params.complexity);
            
            const pattern = {
                triad: generateTriad(params.root, params.quality),
                ensemble: params.ensemble,
                measures: params.measures,
                tempo: params.tempo,
                voices: {},
                timestamp: Date.now()
            };
            
            // Assign different rhythm to each voice
            voices.forEach((voice, index) => {
                const ratioKey = ratios[index % ratios.length];
                const ratio = tupletRatios[ratioKey];
                
                pattern.voices[voice] = {
                    tupletRatio: ratioKey,
                    ratioData: ratio,
                    dynamic: getDynamic(params.complexity, index),
                    notes: generateProperNotes(pattern.triad, ratio, params.measures)
                };
            });
            
            return pattern;
        }
        
        // Get ratios based on complexity
        function getComplexityRatios(complexity) {
            if (complexity <= 2) return ["3:2", "4:3"];
            if (complexity <= 4) return ["3:2", "5:4", "4:3", "6:4"];
            if (complexity <= 6) return ["5:4", "6:4", "7:4", "4:5", "5:3"];
            if (complexity <= 8) return ["7:4", "9:8", "5:3", "11:8", "6:5"];
            return ["11:8", "13:8", "7:6", "9:8", "8:5"];
        }
        
        // Generate proper notes for tuplet
        function generateProperNotes(triad, ratio, measures) {
            const notes = [];
            const triadPitches = [triad.root, triad.third, triad.fifth];
            
            // For each measure
            for (let m = 0; m < measures; m++) {
                // Generate notes for this tuplet
                for (let i = 0; i < ratio.num; i++) {
                    notes.push({
                        measure: m + 1,
                        pitch: triadPitches[i % 3],
                        octave: 4 + Math.floor(i / 6),
                        position: i,
                        duration: Math.floor(1024 / ratio.num) // Actual duration in divisions
                    });
                }
            }
            
            return notes;
        }
        
        // Get dynamic based on complexity
        function getDynamic(complexity, voiceIndex) {
            const dynamics = ["ff", "f", "mf", "mp", "p"];
            const baseIndex = Math.floor((10 - complexity) / 2);
            return dynamics[(baseIndex + voiceIndex) % dynamics.length];
        }
        
        // Generate triad
        function generateTriad(root, quality) {
            const intervals = {
                major: [0, 4, 7],
                minor: [0, 3, 7],
                diminished: [0, 3, 6],
                augmented: [0, 4, 8],
                suspended2: [0, 2, 7],
                suspended4: [0, 5, 7]
            };
            
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const rootIndex = notes.indexOf(root);
            const pattern = intervals[quality] || intervals.major;
            
            return {
                root: root,
                third: notes[(rootIndex + pattern[1]) % 12],
                fifth: notes[(rootIndex + pattern[2]) % 12],
                quality: quality
            };
        }
        
        // Update visualization (V4.0 style with beat indicator)
        function updateVisualization() {
            const tracks = document.getElementById('voiceTracks');
            tracks.innerHTML = '';
            
            if (!currentPattern) return;
            
            Object.entries(currentPattern.voices).forEach(([voice, data]) => {
                const track = document.createElement('div');
                track.className = 'voice-track';
                track.innerHTML = `
                    <div style="position: absolute; left: 10px; top: 20px; color: #ffd700;">
                        ${voice}: ${data.tupletRatio}
                    </div>
                `;
                
                // Add note events based on tuplet ratio
                const ratio = data.ratioData;
                for (let i = 0; i < ratio.num; i++) {
                    const note = document.createElement('div');
                    note.className = 'note-event';
                    note.style.left = `${(i / ratio.num) * 100}%`;
                    note.style.width = `${(1 / ratio.num) * 100}%`;
                    track.appendChild(note);
                }
                
                tracks.appendChild(track);
            });
        }
        
        // Update rhythm grid
        function updateRhythmGrid() {
            const grid = document.getElementById('rhythmGrid');
            grid.innerHTML = '';
            
            if (!currentPattern) return;
            
            Object.entries(currentPattern.voices).forEach(([voice, data]) => {
                const cell = document.createElement('div');
                cell.className = 'rhythm-cell';
                cell.innerHTML = `
                    <div class="voice-label">${voice}</div>
                    <div class="tuplet-display">${data.tupletRatio}</div>
                    <div style="font-size: 0.9em; color: #adbce6;">${data.dynamic}</div>
                `;
                grid.appendChild(cell);
            });
        }
        
        // Update analysis
        function updateAnalysis() {
            const display = document.getElementById('analysisDisplay');
            
            if (!currentPattern) {
                display.innerHTML = '<div>No pattern to analyze</div>';
                return;
            }
            
            const voiceCount = Object.keys(currentPattern.voices).length;
            const uniqueRatios = new Set(Object.values(currentPattern.voices).map(v => v.tupletRatio)).size;
            
            display.innerHTML = `
                <div class="analysis-item">
                    <div class="analysis-label">Voice Count</div>
                    <div class="analysis-value">${voiceCount}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Unique Rhythms</div>
                    <div class="analysis-value">${uniqueRatios}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Measures</div>
                    <div class="analysis-value">${currentPattern.measures}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Tempo</div>
                    <div class="analysis-value">${currentPattern.tempo} BPM</div>
                </div>
            `;
        }
        
        // Update pattern output
        function updatePatternOutput() {
            const output = document.getElementById('patternOutput');
            const voiceOutput = document.getElementById('voiceAssignments');
            
            if (!currentPattern) {
                output.innerHTML = '<pre>No pattern generated yet</pre>';
                return;
            }
            
            // Show summary
            const summary = {
                triad: currentPattern.triad,
                measures: currentPattern.measures,
                tempo: currentPattern.tempo,
                ensemble: currentPattern.ensemble
            };
            
            output.innerHTML = `<pre>${JSON.stringify(summary, null, 2)}</pre>`;
            
            // Voice assignments
            let voiceText = '';
            Object.entries(currentPattern.voices).forEach(([voice, data]) => {
                voiceText += `${voice.toUpperCase()}\n`;
                voiceText += `  Ratio: ${data.tupletRatio}\n`;
                voiceText += `  Dynamic: ${data.dynamic}\n`;
                voiceText += `  Notes: ${data.ratioData.num} per measure\n\n`;
            });
            voiceOutput.innerHTML = `<pre>${voiceText}</pre>`;
        }
        
        // Load preset
        function loadPreset(presetName) {
            const presets = {
                'Minimalist': { complexity: 3, ensemble: 'quartet', measures: 1, tempo: 80 },
                'Jazz Fusion': { complexity: 6, ensemble: 'quintet', measures: 2, tempo: 120 },
                'Progressive': { complexity: 7, ensemble: 'quintet', measures: 4, tempo: 100 },
                'Complex Contemporary': { complexity: 8, ensemble: 'quintet', measures: 1, tempo: 90 }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('complexity').value = preset.complexity;
                document.getElementById('complexityValue').textContent = preset.complexity;
                document.getElementById('ensemble').value = preset.ensemble;
                document.getElementById('totalMeasures').value = preset.measures;
                document.getElementById('tempo').value = preset.tempo;
            }
        }
        
        // FIXED: Export proper Sibelius MusicXML
        function exportMusicXML() {
            if (!currentPattern) {
                alert('Please generate a pattern first');
                return;
            }
            
            const xml = generateSibeliusXML();
            const blob = new Blob([xml], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `polyrhythmic-${currentPattern.triad.root}-${currentPattern.triad.quality}.musicxml`;
            a.click();
        }
        
        // ACTUALLY WORKING Sibelius XML generator
        function generateSibeliusXML() {
            const p = currentPattern;
            const title = `Polyrhythmic Pattern - ${p.triad.root} ${p.triad.quality}`;
            
            // Exact Sibelius header format
            let xml = `<?xml version="1.0" encoding='UTF-8' standalone='no' ?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.0">
 <work>
  <work-title>${title}</work-title>
 </work>
 <identification>
  <encoding>
   <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
   <encoder>PolyrhythmicTriadGen</encoder>
   <software>Sibelius 25.4.0</software>
   <software>Direct export, not from Dolet</software>
   <encoding-description>Sibelius / MusicXML 3.0</encoding-description>
   <supports element="print" type="yes" value="yes" attribute="new-system" />
   <supports element="print" type="yes" value="yes" attribute="new-page" />
   <supports element="accidental" type="yes" />
   <supports element="beam" type="yes" />
   <supports element="stem" type="yes" />
  </encoding>
 </identification>
 <defaults>
  <scaling>
   <millimeters>215.9</millimeters>
   <tenths>1224</tenths>
  </scaling>
  <page-layout>
   <page-height>1584</page-height>
   <page-width>1224</page-width>
   <page-margins type="both">
    <left-margin>85</left-margin>
    <right-margin>85</right-margin>
    <top-margin>85</top-margin>
    <bottom-margin>85</bottom-margin>
   </page-margins>
  </page-layout>
 </defaults>
 <part-list>\n`;
            
            // Build part list
            let partNum = 1;
            const partInfo = {};
            for (const voice in p.voices) {
                partInfo[voice] = partNum;
                const name = getInstrumentName(voice);
                
                xml += `  <score-part id="P${partNum}">
   <part-name>${name}</part-name>
   <part-name-display>
    <display-text>${name}</display-text>
   </part-name-display>
   <score-instrument id="P${partNum}-I1">
    <instrument-name>${name}</instrument-name>
   </score-instrument>
  </score-part>\n`;
                partNum++;
            }
            
            xml += ` </part-list>\n`;
            
            // Generate each part
            for (const [voice, data] of Object.entries(p.voices)) {
                xml += generateSibeliusPart(voice, data, partInfo[voice], p);
            }
            
            xml += '</score-partwise>';
            return xml;
        }
        
        // Generate individual part in Sibelius format
        function generateSibeliusPart(voice, data, partNum, pattern) {
            const clef = getClef(voice);
            const ratio = data.ratioData;
            
            let xml = ` <part id="P${partNum}">\n`;
            
            for (let m = 1; m <= pattern.measures; m++) {
                xml += `  <!--============== Part: P${partNum}, Measure: ${m} ==============-->
  <measure number="${m}" width="920">\n`;
                
                // First measure setup
                if (m === 1) {
                    xml += `   <print new-page="yes">
    <system-layout>
     <system-margins>
      <left-margin>133</left-margin>
      <right-margin>0</right-margin>
     </system-margins>
    </system-layout>
   </print>
   <attributes>
    <divisions>256</divisions>
    <key color="#000000">
     <fifths>0</fifths>
     <mode>major</mode>
    </key>
    <time color="#000000">
     <beats>4</beats>
     <beat-type>4</beat-type>
    </time>
    <clef number="1" color="#000000">
     <sign>${clef.sign}</sign>
     <line>${clef.line}</line>
    </clef>\n`;
                    
                    // Guitar needs transposition
                    if (voice === 'guitar') {
                        xml += `    <transpose>
     <diatonic>0</diatonic>
     <chromatic>0</chromatic>
     <octave-change>-1</octave-change>
    </transpose>\n`;
                    }
                    
                    xml += `   </attributes>\n`;
                    
                    // Tempo on first part only
                    if (partNum === 1) {
                        xml += `   <direction>
    <direction-type>
     <metronome default-y="30" color="#000000">
      <beat-unit>quarter</beat-unit>
      <per-minute>${pattern.tempo}</per-minute>
     </metronome>
    </direction-type>
    <voice>1</voice>
    <staff>1</staff>
   </direction>\n`;
                    }
                    
                    // Dynamics
                    xml += `   <direction>
    <direction-type>
     <dynamics default-x="70" default-y="-76" color="#000000">
      <${data.dynamic} />
     </dynamics>
    </direction-type>
    <voice>1</voice>
    <staff>1</staff>
   </direction>\n`;
                }
                
                // Calculate CORRECT durations for Sibelius
                const measureNotes = data.notes.filter(n => n.measure === m);
                let totalDuration = 0;
                
                // The key insight: Sibelius expects specific duration values for tuplets
                const tupletDuration = Math.floor((1024 * ratio.denom) / (ratio.num * 4));
                
                measureNotes.forEach((note, i) => {
                    const pitch = getPitchInfo(note.pitch);
                    const isFirst = i === 0;
                    const isLast = i === measureNotes.length - 1;
                    
                    xml += `   <note color="#000000">
    <pitch>
     <step>${pitch.step}</step>${pitch.alter ? `
     <alter>${pitch.alter}</alter>` : ''}
     <octave>${note.octave + (voice === 'guitar' ? 1 : 0)}</octave>
    </pitch>
    <duration>${tupletDuration}</duration>
    <instrument id="P${partNum}-I1" />
    <voice>1</voice>
    <type>16th</type>${pitch.alter ? `
    <accidental>sharp</accidental>` : ''}
    <time-modification>
     <actual-notes>${ratio.num}</actual-notes>
     <normal-notes>${ratio.denom}</normal-notes>
     <normal-type>16th</normal-type>
    </time-modification>
    <stem>${note.octave >= 5 ? 'down' : 'up'}</stem>
    <staff>1</staff>\n`;
                    
                    // Beaming
                    if (ratio.num > 2) {
                        if (isFirst) {
                            xml += '    <beam number="1">begin</beam>\n';
                            xml += '    <beam number="2">begin</beam>\n';
                        } else if (isLast) {
                            xml += '    <beam number="1">end</beam>\n';
                            xml += '    <beam number="2">end</beam>\n';
                        } else {
                            xml += '    <beam number="1">continue</beam>\n';
                            xml += '    <beam number="2">continue</beam>\n';
                        }
                    }
                    
                    // Tuplet bracket
                    if (isFirst) {
                        xml += `    <notations>
     <tuplet type="start" bracket="yes" number="1" default-y="-20" placement="${note.octave >= 5 ? 'below' : 'above'}" />
    </notations>\n`;
                    } else if (isLast) {
                        xml += `    <notations>
     <tuplet type="stop" bracket="yes" number="1" default-y="-20" placement="${note.octave >= 5 ? 'below' : 'above'}" />
    </notations>\n`;
                    }
                    
                    xml += '   </note>\n';
                    totalDuration += tupletDuration;
                });
                
                // Fill remaining measure with forward
                const remainingDuration = 1024 - totalDuration;
                if (remainingDuration > 0) {
                    xml += `   <forward>
    <duration>${remainingDuration}</duration>
   </forward>\n`;
                }
                
                // End barline on last measure
                if (m === pattern.measures) {
                    xml += `   <barline>
    <bar-style>light-heavy</bar-style>
   </barline>\n`;
                }
                
                xml += '  </measure>\n';
            }
            
            xml += ' </part>\n';
            return xml;
        }
        
        // Helper functions
        function getInstrumentName(voice) {
            const names = {
                'guitar': 'Jazz Guitar',
                'violin1': 'Violin I',
                'violin2': 'Violin II',
                'viola': 'Viola',
                'cello': 'Violoncello',
                'primary': 'Solo'
            };
            return names[voice] || voice;
        }
        
        function getClef(voice) {
            const clefs = {
                'guitar': { sign: 'G', line: 2 },
                'violin1': { sign: 'G', line: 2 },
                'violin2': { sign: 'G', line: 2 },
                'viola': { sign: 'C', line: 3 },
                'cello': { sign: 'F', line: 4 },
                'primary': { sign: 'G', line: 2 }
            };
            return clefs[voice] || { sign: 'G', line: 2 };
        }
        
        function getPitchInfo(noteName) {
            let step = noteName.replace('#', '');
            let alter = noteName.includes('#') ? 1 : 0;
            return { step, alter };
        }
        
        // Export JSON
        function exportJSON() {
            if (!currentPattern) {
                alert('Please generate a pattern first');
                return;
            }
            
            const blob = new Blob([JSON.stringify(currentPattern, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'polyrhythmic-pattern.json';
            a.click();
        }
        
        // Send to target
        function sendToTarget() {
            const target = document.getElementById('targetApp').value;
            if (!currentPattern) {
                alert('Please generate a pattern first');
                return;
            }
            
            console.log(`Sending pattern to ${target}:`, currentPattern);
            alert(`Pattern sent to ${target}`);
        }
    </script>
</body>
</html>