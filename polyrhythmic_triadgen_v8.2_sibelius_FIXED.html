<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyrhythmic TriadGen v8.2 - Sibelius-Compliant MusicXML</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a0033 0%, #330066 50%, #4d0099 100%);
            color: #fff;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff);
            background-size: 200% auto;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes shimmer {
            to { background-position: 200% center; }
        }

        .version-badge {
            display: inline-block;
            background: #00ff00;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .main-controls {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #00ffcc;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ffcc;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }

        select:hover, input:hover {
            border-color: #ff00ff;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        select:focus, input:focus {
            outline: none;
            border-color: #ffff00;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 25px;
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            border: none;
            border-radius: 25px;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 0, 255, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .export-button {
            background: linear-gradient(45deg, #00ff00, #ffff00);
        }

        .section-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 1.5em;
            color: #00ffcc;
        }

        .rhythm-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .rhythm-chip {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00ffcc;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .rhythm-chip:hover {
            background: rgba(0, 255, 204, 0.3);
            transform: scale(1.05);
        }

        .rhythm-chip.selected {
            background: #00ffcc;
            color: #000;
            font-weight: bold;
        }

        .visualization {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            position: relative;
            overflow: hidden;
        }

        .vis-grid {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .instrument-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .instrument-label {
            min-width: 100px;
            font-weight: bold;
            color: #ffff00;
        }

        .beat-grid {
            display: flex;
            gap: 2px;
            flex: 1;
        }

        .beat-cell {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            transition: all 0.3s;
        }

        .beat-cell.active {
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            animation: beatPulse 0.5s;
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #00ffcc;
            backdrop-filter: blur(10px);
        }

        .status-text {
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a0033, #330066);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00ffcc;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #ff00ff;
        }

        .output-display {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Polyrhythmic TriadGen</h1>
            <div class="version-badge">v8.2 - SIBELIUS-COMPLIANT</div>
        </div>

        <div class="main-controls">
            <h2 style="margin-bottom: 20px; color: #00ffcc;">GLOBAL SETTINGS</h2>
            
            <div class="control-row">
                <div class="control-group">
                    <label>Key Signature</label>
                    <select id="keySelect">
                        <option value="C">C Major / A minor</option>
                        <option value="G">G Major / E minor</option>
                        <option value="D">D Major / B minor</option>
                        <option value="A">A Major / F# minor</option>
                        <option value="E">E Major / C# minor</option>
                        <option value="B">B Major / G# minor</option>
                        <option value="F#">F# Major / D# minor</option>
                        <option value="F">F Major / D minor</option>
                        <option value="Bb">Bb Major / G minor</option>
                        <option value="Eb">Eb Major / C minor</option>
                        <option value="Ab">Ab Major / F minor</option>
                        <option value="Db">Db Major / Bb minor</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Time Signature</label>
                    <select id="timeSignature">
                        <option value="4/4">4/4</option>
                        <option value="3/4">3/4</option>
                        <option value="6/8">6/8</option>
                        <option value="5/4">5/4</option>
                        <option value="7/8">7/8</option>
                        <option value="9/8">9/8</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Tempo (BPM)</label>
                    <input type="number" id="tempo" value="120" min="40" max="300">
                </div>

                <div class="control-group">
                    <label>Measures</label>
                    <input type="number" id="measures" value="8" min="1" max="64">
                </div>

                <div class="control-group">
                    <label>Output Format</label>
                    <select id="outputFormat">
                        <option value="quintet">Quintet (Guitar + Strings)</option>
                        <option value="quartet">String Quartet</option>
                        <option value="gcc">GCC Format</option>
                        <option value="raw">Raw Notes</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button onclick="generateMusic()">üéµ GENERATE</button>
                <button onclick="playPreview()" style="background: linear-gradient(45deg, #ff6b6b, #ffd93d);">‚ñ∂Ô∏è PLAY PREVIEW</button>
                <button onclick="exportMusicXML()" class="export-button">üìÑ EXPORT MUSICXML (SIBELIUS)</button>
                <button onclick="exportMIDI()" style="background: linear-gradient(45deg, #6bcf7f, #1e90ff);">üéπ EXPORT MIDI</button>
            </div>
        </div>

        <!-- Section A -->
        <div class="section-container">
            <div class="section-header">
                <h3 class="section-title">SECTION A - Introduction</h3>
                <div>
                    <label style="display: inline; margin-right: 10px;">Measures:</label>
                    <input type="number" id="sectionA_measures" value="4" min="1" max="32" style="width: 80px;">
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-group">
                    <label>Rhythm Pattern</label>
                    <select id="sectionA_rhythm">
                        <option value="simple">Simple (4/4, 3/4)</option>
                        <option value="polyrhythm">Polyrhythm</option>
                        <option value="complex">Complex Pattern</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Polyrhythm Type</label>
                    <select id="sectionA_polyrhythm">
                        <option value="2:3">2:3 (Hemiola)</option>
                        <option value="3:4">3:4</option>
                        <option value="4:5">4:5</option>
                        <option value="5:6">5:6</option>
                        <option value="7:8">7:8</option>
                        <option value="3:5">3:5</option>
                        <option value="5:7">5:7</option>
                        <option value="7:11">7:11</option>
                        <option value="11:13">11:13</option>
                        <option value="13:17">13:17</option>
                        <option value="17:19">17:19</option>
                    </select>
                </div>
            </div>
            
            <div class="rhythm-chips">
                <div class="rhythm-chip" onclick="selectRhythm('A', 'simple')">Simple</div>
                <div class="rhythm-chip" onclick="selectRhythm('A', '2:3')">2:3</div>
                <div class="rhythm-chip" onclick="selectRhythm('A', '3:4')">3:4</div>
                <div class="rhythm-chip" onclick="selectRhythm('A', '4:5')">4:5</div>
                <div class="rhythm-chip" onclick="selectRhythm('A', '5:7')">5:7</div>
                <div class="rhythm-chip" onclick="selectRhythm('A', '7:11')">7:11</div>
            </div>
            
            <div class="visualization" id="sectionA_vis">
                <div class="vis-grid" id="sectionA_grid"></div>
            </div>
        </div>

        <!-- Section B -->
        <div class="section-container">
            <div class="section-header">
                <h3 class="section-title">SECTION B - Development</h3>
                <div>
                    <label style="display: inline; margin-right: 10px;">Measures:</label>
                    <input type="number" id="sectionB_measures" value="4" min="1" max="32" style="width: 80px;">
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-group">
                    <label>Rhythm Pattern</label>
                    <select id="sectionB_rhythm">
                        <option value="simple">Simple (4/4, 3/4)</option>
                        <option value="polyrhythm" selected>Polyrhythm</option>
                        <option value="complex">Complex Pattern</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Polyrhythm Type</label>
                    <select id="sectionB_polyrhythm">
                        <option value="2:3">2:3 (Hemiola)</option>
                        <option value="3:4" selected>3:4</option>
                        <option value="4:5">4:5</option>
                        <option value="5:6">5:6</option>
                        <option value="7:8">7:8</option>
                        <option value="3:5">3:5</option>
                        <option value="5:7">5:7</option>
                        <option value="7:11">7:11</option>
                        <option value="11:13">11:13</option>
                        <option value="13:17">13:17</option>
                        <option value="17:19">17:19</option>
                    </select>
                </div>
            </div>
            
            <div class="rhythm-chips">
                <div class="rhythm-chip" onclick="selectRhythm('B', 'simple')">Simple</div>
                <div class="rhythm-chip" onclick="selectRhythm('B', '2:3')">2:3</div>
                <div class="rhythm-chip selected" onclick="selectRhythm('B', '3:4')">3:4</div>
                <div class="rhythm-chip" onclick="selectRhythm('B', '4:5')">4:5</div>
                <div class="rhythm-chip" onclick="selectRhythm('B', '5:7')">5:7</div>
                <div class="rhythm-chip" onclick="selectRhythm('B', '7:11')">7:11</div>
            </div>
            
            <div class="visualization" id="sectionB_vis">
                <div class="vis-grid" id="sectionB_grid"></div>
            </div>
        </div>

        <!-- Section C -->
        <div class="section-container">
            <div class="section-header">
                <h3 class="section-title">SECTION C - Climax</h3>
                <div>
                    <label style="display: inline; margin-right: 10px;">Measures:</label>
                    <input type="number" id="sectionC_measures" value="4" min="1" max="32" style="width: 80px;">
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-group">
                    <label>Rhythm Pattern</label>
                    <select id="sectionC_rhythm">
                        <option value="simple">Simple (4/4, 3/4)</option>
                        <option value="polyrhythm" selected>Polyrhythm</option>
                        <option value="complex">Complex Pattern</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Polyrhythm Type</label>
                    <select id="sectionC_polyrhythm">
                        <option value="2:3">2:3 (Hemiola)</option>
                        <option value="3:4">3:4</option>
                        <option value="4:5">4:5</option>
                        <option value="5:6">5:6</option>
                        <option value="7:8">7:8</option>
                        <option value="3:5">3:5</option>
                        <option value="5:7" selected>5:7</option>
                        <option value="7:11">7:11</option>
                        <option value="11:13">11:13</option>
                        <option value="13:17">13:17</option>
                        <option value="17:19">17:19</option>
                    </select>
                </div>
            </div>
            
            <div class="rhythm-chips">
                <div class="rhythm-chip" onclick="selectRhythm('C', 'simple')">Simple</div>
                <div class="rhythm-chip" onclick="selectRhythm('C', '2:3')">2:3</div>
                <div class="rhythm-chip" onclick="selectRhythm('C', '3:4')">3:4</div>
                <div class="rhythm-chip" onclick="selectRhythm('C', '4:5')">4:5</div>
                <div class="rhythm-chip selected" onclick="selectRhythm('C', '5:7')">5:7</div>
                <div class="rhythm-chip" onclick="selectRhythm('C', '7:11')">7:11</div>
            </div>
            
            <div class="visualization" id="sectionC_vis">
                <div class="vis-grid" id="sectionC_grid"></div>
            </div>
        </div>

        <div class="status-bar">
            <span class="status-text" id="statusText">Ready to generate polyrhythmic compositions...</span>
            <span class="status-text" id="statusInfo">v8.2 - Sibelius-Compliant MusicXML</span>
        </div>

        <!-- Output Modal -->
        <div id="outputModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: #00ffcc;">Generated Output</h2>
                    <button class="close-modal" onclick="closeModal()">&times;</button>
                </div>
                <div id="outputContent" class="output-display"></div>
                <div class="button-group" style="margin-top: 20px;">
                    <button onclick="copyOutput()">üìã COPY</button>
                    <button onclick="downloadOutput()">üíæ DOWNLOAD</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let generatedMusic = null;
        let currentOutput = '';
        
        // MusicXML Sibelius-compliant constants (from actual Sibelius exports)
        const MUSICXML_CONFIG = {
            divisions: 256,  // Sibelius uses 256, not 768!
            encoding: 'UTF-8',
            version: '3.0',  // Sibelius exports as 3.0
            // Duration map based on divisions=256
            durations: {
                whole: 1024,      // 256 * 4
                half: 512,        // 256 * 2
                quarter: 256,     // 256 * 1
                eighth: 128,      // 256 / 2
                sixteenth: 64,    // 256 / 4
                thirtySecond: 32, // 256 / 8
                dottedHalf: 768,  // 512 * 1.5
                dottedQuarter: 384, // 256 * 1.5
                dottedEighth: 192   // 128 * 1.5
            }
        };

        // Note mappings
        const noteMap = {
            'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
            'D': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
            'A': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
            'E': ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'],
            'B': ['B', 'C#', 'D#', 'E', 'F#', 'G#', 'A#'],
            'F#': ['F#', 'G#', 'A#', 'B', 'C#', 'D#', 'E#'],
            'F': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'],
            'Bb': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'],
            'Eb': ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'],
            'Ab': ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'],
            'Db': ['Db', 'Eb', 'F', 'Gb', 'Ab', 'Bb', 'C']
        };

        function selectRhythm(section, rhythm) {
            // Update UI
            const chips = document.querySelectorAll(`#section${section}_vis`).closest('.section-container').querySelectorAll('.rhythm-chip');
            chips.forEach(chip => chip.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Update selects
            if (rhythm === 'simple') {
                document.getElementById(`section${section}_rhythm`).value = 'simple';
            } else {
                document.getElementById(`section${section}_rhythm`).value = 'polyrhythm';
                document.getElementById(`section${section}_polyrhythm`).value = rhythm;
            }
            
            updateVisualization(section);
        }

        function updateVisualization(section) {
            const grid = document.getElementById(`section${section}_grid`);
            const rhythm = document.getElementById(`section${section}_rhythm`).value;
            const polyrhythm = document.getElementById(`section${section}_polyrhythm`).value;
            
            grid.innerHTML = '';
            
            // Create visualization based on rhythm type
            const instruments = ['Guitar', 'Violin I', 'Violin II', 'Viola', 'Cello'];
            
            instruments.forEach(inst => {
                const row = document.createElement('div');
                row.className = 'instrument-row';
                
                const label = document.createElement('div');
                label.className = 'instrument-label';
                label.textContent = inst;
                row.appendChild(label);
                
                const beatGrid = document.createElement('div');
                beatGrid.className = 'beat-grid';
                
                // Create beat cells
                const numBeats = rhythm === 'polyrhythm' ? 16 : 8;
                for (let i = 0; i < numBeats; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'beat-cell';
                    
                    // Add some pattern
                    if (rhythm === 'polyrhythm' && polyrhythm) {
                        const [a, b] = polyrhythm.split(':').map(Number);
                        if (inst === 'Guitar' && i % Math.floor(numBeats/a) === 0) {
                            cell.classList.add('active');
                        } else if (inst !== 'Guitar' && i % Math.floor(numBeats/b) === 0) {
                            cell.classList.add('active');
                        }
                    } else if (i % 4 === 0) {
                        cell.classList.add('active');
                    }
                    
                    beatGrid.appendChild(cell);
                }
                
                row.appendChild(beatGrid);
                grid.appendChild(row);
            });
        }

        function generateMusic() {
            updateStatus('Generating polyrhythmic composition...');
            
            const key = document.getElementById('keySelect').value;
            const timeSignature = document.getElementById('timeSignature').value;
            const tempo = parseInt(document.getElementById('tempo').value);
            const format = document.getElementById('outputFormat').value;
            
            // Collect section data
            const sections = {
                A: {
                    measures: parseInt(document.getElementById('sectionA_measures').value),
                    rhythm: document.getElementById('sectionA_rhythm').value,
                    polyrhythm: document.getElementById('sectionA_polyrhythm').value
                },
                B: {
                    measures: parseInt(document.getElementById('sectionB_measures').value),
                    rhythm: document.getElementById('sectionB_rhythm').value,
                    polyrhythm: document.getElementById('sectionB_polyrhythm').value
                },
                C: {
                    measures: parseInt(document.getElementById('sectionC_measures').value),
                    rhythm: document.getElementById('sectionC_rhythm').value,
                    polyrhythm: document.getElementById('sectionC_polyrhythm').value
                }
            };
            
            // Generate the music
            generatedMusic = createComposition(key, timeSignature, tempo, sections, format);
            
            // Display output
            currentOutput = formatOutput(generatedMusic, format);
            showOutput(currentOutput);
            
            updateStatus('Composition generated successfully!');
        }

        function createComposition(key, timeSignature, tempo, sections, format) {
            const composition = {
                key: key,
                timeSignature: timeSignature,
                tempo: tempo,
                sections: {},
                format: format
            };
            
            const scale = noteMap[key];
            
            // Generate each section
            Object.keys(sections).forEach(sectionName => {
                const section = sections[sectionName];
                composition.sections[sectionName] = generateSection(scale, section, timeSignature);
            });
            
            return composition;
        }

        function generateSection(scale, sectionConfig, timeSignature) {
            const measures = [];
            const [beats, beatType] = timeSignature.split('/').map(Number);
            
            for (let m = 0; m < sectionConfig.measures; m++) {
                const measure = {
                    guitar: [],
                    violin1: [],
                    violin2: [],
                    viola: [],
                    cello: []
                };
                
                if (sectionConfig.rhythm === 'polyrhythm' && sectionConfig.polyrhythm) {
                    const [a, b] = sectionConfig.polyrhythm.split(':').map(Number);
                    
                    // Calculate proper durations for polyrhythm
                    // Total measure duration in divisions (256 per quarter note)
                    const totalDuration = MUSICXML_CONFIG.divisions * beats;
                    
                    // Guitar plays 'a' notes evenly spaced
                    // For 7 notes in 4 beats: 256*4/7 = 146 (but Sibelius uses 73 with time-mod)
                    const guitarNoteDuration = Math.floor(totalDuration / a);
                    for (let i = 0; i < a; i++) {
                        const note = scale[Math.floor(Math.random() * scale.length)];
                        const octave = 3 + Math.floor(Math.random() * 2);
                        measure.guitar.push({ 
                            note, 
                            octave, 
                            duration: guitarNoteDuration,
                            isTuplet: a !== beats,
                            actualNotes: a,
                            normalNotes: beats
                        });
                    }
                    
                    // Strings play 'b' notes evenly spaced
                    const stringNoteDuration = Math.floor(totalDuration / b);
                    for (let i = 0; i < b; i++) {
                        const note = scale[Math.floor(Math.random() * scale.length)];
                        
                        measure.violin1.push({ 
                            note, 
                            octave: 4, 
                            duration: stringNoteDuration,
                            isTuplet: b !== beats,
                            actualNotes: b,
                            normalNotes: beats
                        });
                        measure.violin2.push({ 
                            note, 
                            octave: 4, 
                            duration: stringNoteDuration,
                            isTuplet: b !== beats,
                            actualNotes: b,
                            normalNotes: beats
                        });
                        measure.viola.push({ 
                            note, 
                            octave: 3, 
                            duration: stringNoteDuration,
                            isTuplet: b !== beats,
                            actualNotes: b,
                            normalNotes: beats
                        });
                        measure.cello.push({ 
                            note, 
                            octave: 2, 
                            duration: stringNoteDuration,
                            isTuplet: b !== beats,
                            actualNotes: b,
                            normalNotes: beats
                        });
                    }
                } else {
                    // Simple rhythm - regular quarter notes
                    for (let beat = 0; beat < beats; beat++) {
                        const note = scale[Math.floor(Math.random() * scale.length)];
                        const duration = MUSICXML_CONFIG.divisions; // Quarter note = 256
                        
                        measure.guitar.push({ note, octave: 3, duration });
                        measure.violin1.push({ note, octave: 4, duration });
                        measure.violin2.push({ note, octave: 4, duration });
                        measure.viola.push({ note, octave: 3, duration });
                        measure.cello.push({ note, octave: 2, duration });
                    }
                }
                
                measures.push(measure);
            }
            
            return measures;
        }

        function calculatePolyrhythmDuration(baseBeats, polyBeats) {
            // For X:Y polyrhythm, each note of X gets this duration
            // Based on divisions=768 for a quarter note
            return Math.round((MUSICXML_CONFIG.durations.quarter * baseBeats) / polyBeats);
        }

        function formatOutput(music, format) {
            let output = `// Polyrhythmic TriadGen v8.2\n`;
            output += `// Key: ${music.key}, Time: ${music.timeSignature}, Tempo: ${music.tempo} BPM\n\n`;
            
            Object.keys(music.sections).forEach(sectionName => {
                output += `\n// SECTION ${sectionName}\n`;
                const section = music.sections[sectionName];
                
                section.forEach((measure, idx) => {
                    output += `\n// Measure ${idx + 1}\n`;
                    
                    if (format === 'quintet') {
                        output += `Guitar: ${formatNotes(measure.guitar)}\n`;
                        output += `Violin I: ${formatNotes(measure.violin1)}\n`;
                        output += `Violin II: ${formatNotes(measure.violin2)}\n`;
                        output += `Viola: ${formatNotes(measure.viola)}\n`;
                        output += `Cello: ${formatNotes(measure.cello)}\n`;
                    } else if (format === 'quartet') {
                        output += `Violin I: ${formatNotes(measure.violin1)}\n`;
                        output += `Violin II: ${formatNotes(measure.violin2)}\n`;
                        output += `Viola: ${formatNotes(measure.viola)}\n`;
                        output += `Cello: ${formatNotes(measure.cello)}\n`;
                    } else if (format === 'gcc') {
                        output += `GCC: ${formatGCC(measure)}\n`;
                    } else {
                        output += JSON.stringify(measure, null, 2) + '\n';
                    }
                });
            });
            
            return output;
        }

        function formatNotes(notes) {
            return notes.map(n => `${n.note}${n.octave}`).join(' ');
        }

        function formatGCC(measure) {
            // Format for GCC compatibility
            const allNotes = [
                ...measure.guitar,
                ...measure.violin1,
                ...measure.violin2,
                ...measure.viola,
                ...measure.cello
            ];
            return allNotes.map(n => `${n.note}${n.octave}:${n.duration}`).join(' | ');
        }

        function exportMusicXML() {
            if (!generatedMusic) {
                alert('Please generate music first!');
                return;
            }
            
            updateStatus('Exporting Sibelius-compliant MusicXML...');
            
            const xml = generateSibeliusCompliantMusicXML(generatedMusic);
            downloadFile(xml, 'polyrhythmic_composition.musicxml', 'application/vnd.recordare.musicxml+xml');
            
            updateStatus('MusicXML exported successfully (Sibelius-compliant)!');
        }

        function generateSibeliusCompliantMusicXML(music) {
            // Based on actual Sibelius export format
            let xml = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n`;
            // Sibelius DOES use DOCTYPE
            xml += `<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n`;
            
            xml += `<score-partwise version="3.0">\n`;
            
            // Add work title
            xml += `  <work>\n`;
            xml += `    <work-title>Polyrhythmic Composition</work-title>\n`;
            xml += `  </work>\n`;
            
            // Add identification
            xml += `  <identification>\n`;
            xml += `    <encoding>\n`;
            xml += `      <software>Polyrhythmic TriadGen v8.2</software>\n`;
            xml += `      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>\n`;
            xml += `    </encoding>\n`;
            xml += `  </identification>\n`;
            
            // Part list
            xml += `  <part-list>\n`;
            
            const parts = music.format === 'quintet' 
                ? ['Guitar', 'Violin I', 'Violin II', 'Viola', 'Cello']
                : ['Violin I', 'Violin II', 'Viola', 'Cello'];
            
            parts.forEach((part, idx) => {
                xml += `    <score-part id="P${idx + 1}">\n`;
                xml += `      <part-name>${part}</part-name>\n`;
                xml += `    </score-part>\n`;
            });
            
            xml += `  </part-list>\n`;
            
            // Generate parts
            parts.forEach((partName, partIdx) => {
                xml += `  <part id="P${partIdx + 1}">\n`;
                
                let measureNum = 1;
                
                Object.keys(music.sections).forEach(sectionName => {
                    const section = music.sections[sectionName];
                    
                    section.forEach((measure, idx) => {
                        xml += `    <measure number="${measureNum}">\n`;
                        
                        // First measure needs attributes
                        if (measureNum === 1) {
                            xml += `      <attributes>\n`;
                            xml += `        <divisions>${MUSICXML_CONFIG.divisions}</divisions>\n`;
                            xml += `        <key>\n`;
                            xml += `          <fifths>${getKeyFifths(music.key)}</fifths>\n`;
                            xml += `        </key>\n`;
                            
                            const [beats, beatType] = music.timeSignature.split('/');
                            xml += `        <time>\n`;
                            xml += `          <beats>${beats}</beats>\n`;
                            xml += `          <beat-type>${beatType}</beat-type>\n`;
                            xml += `        </time>\n`;
                            
                            // Clef based on instrument
                            const clef = getClefForPart(partName);
                            xml += `        <clef>\n`;
                            xml += `          <sign>${clef.sign}</sign>\n`;
                            xml += `          <line>${clef.line}</line>\n`;
                            
                            // Add octave change for guitar
                            if (partName === 'Guitar') {
                                xml += `          <clef-octave-change>-1</clef-octave-change>\n`;
                            }
                            
                            xml += `        </clef>\n`;
                            xml += `      </attributes>\n`;
                        }
                        
                        // Get notes for this part - fix the key mapping
                        let partKey;
                        switch(partName) {
                            case 'Guitar': partKey = 'guitar'; break;
                            case 'Violin I': partKey = 'violin1'; break;
                            case 'Violin II': partKey = 'violin2'; break;
                            case 'Viola': partKey = 'viola'; break;
                            case 'Cello': partKey = 'cello'; break;
                            default: partKey = 'guitar';
                        }
                        
                        const notes = measure[partKey] || [];
                        
                        // Add notes following Sibelius format
                        notes.forEach((noteData, noteIndex) => {
                            xml += createSibeliusNote(noteData, noteIndex === 0, noteIndex === notes.length - 1);
                        });
                        
                        xml += `    </measure>\n`;
                        measureNum++;
                    });
                });
                
                xml += `  </part>\n`;
            });
            
            xml += `</score-partwise>`;
            
            return xml;
        }

        function createSibeliusNote(noteData, isFirstInTuplet, isLastInTuplet) {
            // Follow Sibelius's exact format from the exports
            let xml = `      <note>\n`;
            
            // 1. Pitch (or rest)
            if (noteData.note) {
                const step = noteData.note.charAt(0);
                const hasSharp = noteData.note.includes('#');
                const hasFlat = noteData.note.includes('b') && noteData.note !== 'B';
                
                xml += `        <pitch>\n`;
                xml += `          <step>${step}</step>\n`;
                if (hasSharp) {
                    xml += `          <alter>1</alter>\n`;
                } else if (hasFlat) {
                    xml += `          <alter>-1</alter>\n`;
                }
                xml += `          <octave>${noteData.octave}</octave>\n`;
                xml += `        </pitch>\n`;
            } else {
                xml += `        <rest/>\n`;
            }
            
            // 2. Duration (based on divisions=256)
            xml += `        <duration>${noteData.duration}</duration>\n`;
            
            // 3. Voice
            xml += `        <voice>1</voice>\n`;
            
            // 4. Type - determine from duration or tuplet info
            let noteType = getDurationType(noteData.duration);
            if (noteData.isTuplet) {
                // Adjust type for tuplets
                if (noteData.actualNotes >= 7) {
                    noteType = 'eighth';
                } else if (noteData.actualNotes >= 5) {
                    noteType = 'eighth';
                } else if (noteData.actualNotes === 3) {
                    noteType = 'quarter';
                }
            }
            xml += `        <type>${noteType}</type>\n`;
            
            // 5. Time-modification for tuplets
            if (noteData.isTuplet) {
                xml += `        <time-modification>\n`;
                xml += `          <actual-notes>${noteData.actualNotes}</actual-notes>\n`;
                xml += `          <normal-notes>${noteData.normalNotes}</normal-notes>\n`;
                xml += `        </time-modification>\n`;
            }
            
            // 6. Stem direction
            xml += `        <stem>down</stem>\n`;
            
            // 7. Notations for tuplet brackets
            if (noteData.isTuplet && (isFirstInTuplet || isLastInTuplet)) {
                xml += `        <notations>\n`;
                if (isFirstInTuplet) {
                    xml += `          <tuplet type="start" bracket="yes" number="1"/>\n`;
                }
                if (isLastInTuplet) {
                    xml += `          <tuplet type="stop" bracket="yes" number="1"/>\n`;
                }
                xml += `        </notations>\n`;
            }
            
            xml += `      </note>\n`;
            
            return xml;
        }

        function getDurationType(duration) {
            // Based on divisions=768
            if (duration >= 3072) return 'whole';
            if (duration >= 1536) return 'half';
            if (duration >= 768) return 'quarter';
            if (duration >= 384) return 'eighth';
            if (duration >= 192) return '16th';
            if (duration >= 96) return '32nd';
            return '64th';
        }

        function getKeyFifths(key) {
            const fifths = {
                'C': 0, 'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5, 'F#': 6,
                'F': -1, 'Bb': -2, 'Eb': -3, 'Ab': -4, 'Db': -5
            };
            return fifths[key] || 0;
        }

        function getClefForPart(partName) {
            if (partName.toLowerCase().includes('cello')) {
                return { sign: 'F', line: 4 };
            } else if (partName.toLowerCase().includes('viola')) {
                return { sign: 'C', line: 3 };
            }
            return { sign: 'G', line: 2 };
        }

        function exportMIDI() {
            if (!generatedMusic) {
                alert('Please generate music first!');
                return;
            }
            
            updateStatus('MIDI export coming soon...');
            // TODO: Implement MIDI export
        }

        function playPreview() {
            updateStatus('Audio preview coming soon...');
            // TODO: Implement audio preview
        }

        function showOutput(content) {
            currentOutput = content;
            document.getElementById('outputContent').textContent = content;
            document.getElementById('outputModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('outputModal').style.display = 'none';
        }

        function copyOutput() {
            navigator.clipboard.writeText(currentOutput).then(() => {
                updateStatus('Output copied to clipboard!');
            });
        }

        function downloadOutput() {
            const format = document.getElementById('outputFormat').value;
            const extension = format === 'gcc' ? 'gcc' : 'txt';
            downloadFile(currentOutput, `polyrhythmic_output.${extension}`, 'text/plain');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        // Initialize visualizations
        document.addEventListener('DOMContentLoaded', () => {
            ['A', 'B', 'C'].forEach(section => {
                updateVisualization(section);
            });
            
            // Update visualizations when settings change
            ['rhythm', 'polyrhythm'].forEach(control => {
                ['A', 'B', 'C'].forEach(section => {
                    document.getElementById(`section${section}_${control}`).addEventListener('change', () => {
                        updateVisualization(section);
                    });
                });
            });
        });

        // Close modal on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('outputModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>