<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyrhythmicTriadGen v5.0 - Extended Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            color: #adbce6;
            font-size: 1.1em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: #ffd700;
            font-size: 1.3em;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #adbce6;
            font-size: 0.9em;
        }
        
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        
        select option {
            background: #2a5298;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1e3c72;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }
        
        .section-container {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .section-title {
            color: #ffd700;
            font-weight: bold;
        }
        
        .section-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .rhythm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .rhythm-cell {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        
        .voice-label {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .tuplet-display {
            font-size: 1.5em;
            margin: 10px 0;
        }
        
        #visualizer {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .measure-indicator {
            position: absolute;
            width: 1px;
            height: 100%;
            background: rgba(255,255,255,0.2);
            border-right: 1px dashed rgba(255,255,255,0.3);
        }
        
        .section-marker {
            position: absolute;
            top: 0;
            padding: 2px 8px;
            background: #ffd700;
            color: #1e3c72;
            font-weight: bold;
            border-radius: 0 0 5px 5px;
            font-size: 0.9em;
        }
        
        .voice-track {
            height: 60px;
            margin: 10px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        
        .note-event {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.6), transparent);
            width: 20px;
            border-radius: 3px;
        }
        
        .complexity-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #adbce6;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .preset-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px;
            font-size: 0.9em;
        }
        
        .preset-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
        }
        
        .output-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .code-output {
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .analysis-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .analysis-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
        }
        
        .analysis-label {
            color: #adbce6;
            font-size: 0.8em;
        }
        
        .analysis-value {
            font-size: 1.2em;
            color: #ffd700;
            font-weight: bold;
        }
        
        .remove-section-btn {
            background: rgba(255,50,50,0.5);
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .measure-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PolyrhythmicTriadGen v5.0</h1>
            <div class="subtitle">Extended Multi-Measure Polyrhythmic Generation with Section Structure</div>
        </header>
        
        <div class="main-grid">
            <!-- Left Panel: Structure & Sections -->
            <div class="panel">
                <h2>Composition Structure</h2>
                
                <div class="control-group">
                    <label>Total Measures</label>
                    <input type="number" id="totalMeasures" min="1" max="32" value="8">
                </div>
                
                <div class="control-group">
                    <label>Time Signature</label>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 5px;">
                        <input type="number" id="beatsPerMeasure" min="1" max="12" value="4">
                        <span style="text-align: center; padding: 8px;">/</span>
                        <select id="beatUnit">
                            <option value="2">2</option>
                            <option value="4" selected>4</option>
                            <option value="8">8</option>
                            <option value="16">16</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Tempo (BPM)</label>
                    <input type="number" id="tempo" min="40" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <label>Ensemble Type</label>
                    <select id="ensemble">
                        <option value="solo">Solo</option>
                        <option value="quartet">String Quartet</option>
                        <option value="quintet" selected>String Quintet (with Guitar)</option>
                    </select>
                </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: #ffd700;">Sections</h3>
                
                <div id="sectionsContainer">
                    <!-- Sections will be added here dynamically -->
                </div>
                
                <button onclick="addSection()" style="width: 100%; margin-top: 10px;">
                    + Add Section
                </button>
                
                <div style="margin-top: 20px;">
                    <button onclick="generateFullComposition()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                        GENERATE FULL COMPOSITION
                    </button>
                </div>
            </div>
            
            <!-- Center Panel: Visualization -->
            <div class="panel">
                <h2>Polyrhythmic Visualization</h2>
                <div id="visualizer">
                    <div id="measureMarkers"></div>
                    <div id="sectionMarkers"></div>
                    <div id="voiceTracks"></div>
                </div>
                
                <div class="rhythm-grid" id="rhythmGrid">
                    <!-- Current rhythm assignments will be displayed here -->
                </div>
                
                <div class="output-section">
                    <h3 style="margin-bottom: 10px;">Composition Analysis</h3>
                    <div class="analysis-display" id="analysisDisplay">
                        <!-- Analysis results here -->
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Triad & Export -->
            <div class="panel">
                <h2>Triad Configuration & Export</h2>
                
                <div class="control-group">
                    <label>Root Note</label>
                    <select id="rootNote">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D" selected>D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Triad Quality</label>
                    <select id="quality">
                        <option value="major" selected>Major</option>
                        <option value="minor">Minor</option>
                        <option value="diminished">Diminished</option>
                        <option value="augmented">Augmented</option>
                        <option value="suspended2">Sus2</option>
                        <option value="suspended4">Sus4</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Tonal System</label>
                    <select id="tonalSystem">
                        <option value="chromatic" selected>Chromatic</option>
                        <option value="diatonic">Diatonic</option>
                        <option value="whole-tone">Whole Tone</option>
                        <option value="octatonic">Octatonic</option>
                        <option value="hexatonic">Hexatonic</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="polytonal"> Enable Polytonal Layers
                    </label>
                </div>
                
                <div class="control-group">
                    <label>Presets</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadPreset('Minimalist')">Minimalist</button>
                        <button class="preset-btn" onclick="loadPreset('Jazz Fusion')">Jazz Fusion</button>
                        <button class="preset-btn" onclick="loadPreset('Progressive')">Progressive</button>
                        <button class="preset-btn" onclick="loadPreset('Complex Contemporary')">Contemporary</button>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <button onclick="exportSibeliusMusicXML()" style="width: 100%;">
                        Export MusicXML (Sibelius)
                    </button>
                    <button onclick="exportJSON()" style="width: 100%; margin-top: 10px;">
                        Export JSON Data
                    </button>
                </div>
                
                <div class="output-section">
                    <h3>Current Pattern Data</h3>
                    <div class="code-output" id="patternOutput">
                        <pre>No composition generated yet</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // =====================================================
        // ENHANCED POLYRHYTHMIC ENGINE v5.0
        // =====================================================
        
        // Global composition storage
        let currentComposition = {
            measures: 8,
            sections: [],
            voices: {},
            timeSignature: { beats: 4, beatType: 4 },
            tempo: 100
        };
        
        // Section counter
        let sectionCounter = 0;
        
        // Tuplet library with complexity ratings
        const tupletLibrary = {
            simple: [
                { ratio: "2:3", num: 2, denom: 3, complexity: 1 },
                { ratio: "3:2", num: 3, denom: 2, complexity: 1 },
                { ratio: "4:3", num: 4, denom: 3, complexity: 2 },
                { ratio: "3:4", num: 3, denom: 4, complexity: 2 }
            ],
            intermediate: [
                { ratio: "5:4", num: 5, denom: 4, complexity: 3 },
                { ratio: "4:5", num: 4, denom: 5, complexity: 3 },
                { ratio: "5:3", num: 5, denom: 3, complexity: 4 },
                { ratio: "6:5", num: 6, denom: 5, complexity: 4 },
                { ratio: "7:4", num: 7, denom: 4, complexity: 5 },
                { ratio: "7:6", num: 7, denom: 6, complexity: 5 },
                { ratio: "6:4", num: 6, denom: 4, complexity: 3 }
            ],
            complex: [
                { ratio: "8:5", num: 8, denom: 5, complexity: 6 },
                { ratio: "9:8", num: 9, denom: 8, complexity: 6 },
                { ratio: "11:8", num: 11, denom: 8, complexity: 7 },
                { ratio: "13:8", num: 13, denom: 8, complexity: 8 },
                { ratio: "15:8", num: 15, denom: 8, complexity: 9 },
                { ratio: "17:16", num: 17, denom: 16, complexity: 10 }
            ]
        };
        
        // Initialize with default section on load
        document.addEventListener('DOMContentLoaded', function() {
            addSection(); // Add initial Section A
        });
        
        // Add a new section
        function addSection() {
            const letter = String.fromCharCode(65 + sectionCounter); // A, B, C, etc.
            sectionCounter++;
            
            const section = {
                id: `section_${sectionCounter}`,
                letter: letter,
                startMeasure: 1,
                endMeasure: 8,
                complexity: 5,
                triadChanges: []
            };
            
            currentComposition.sections.push(section);
            renderSection(section);
        }
        
        // Render section controls
        function renderSection(section) {
            const container = document.getElementById('sectionsContainer');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section-container';
            sectionDiv.id = section.id;
            
            sectionDiv.innerHTML = `
                <div class="section-header">
                    <div class="section-title">Section ${section.letter}</div>
                    <button class="remove-section-btn" onclick="removeSection('${section.id}')">Remove</button>
                </div>
                <div class="section-controls">
                    <div>
                        <label style="font-size: 0.85em;">Start Measure</label>
                        <input type="number" id="${section.id}_start" min="1" max="32" value="${section.startMeasure}" 
                               onchange="updateSection('${section.id}', 'start', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">End Measure</label>
                        <input type="number" id="${section.id}_end" min="1" max="32" value="${section.endMeasure}"
                               onchange="updateSection('${section.id}', 'end', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">Complexity</label>
                        <input type="range" min="1" max="10" value="${section.complexity}" 
                               onchange="updateSection('${section.id}', 'complexity', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">Rhythm Pattern</label>
                        <select onchange="updateSection('${section.id}', 'pattern', this.value)">
                            <option value="progressive">Progressive</option>
                            <option value="static">Static</option>
                            <option value="alternating">Alternating</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(sectionDiv);
        }
        
        // Update section parameters
        function updateSection(sectionId, param, value) {
            const section = currentComposition.sections.find(s => s.id === sectionId);
            if (section) {
                if (param === 'start') section.startMeasure = parseInt(value);
                else if (param === 'end') section.endMeasure = parseInt(value);
                else if (param === 'complexity') section.complexity = parseInt(value);
                else if (param === 'pattern') section.rhythmPattern = value;
            }
        }
        
        // Remove section
        function removeSection(sectionId) {
            currentComposition.sections = currentComposition.sections.filter(s => s.id !== sectionId);
            document.getElementById(sectionId).remove();
        }
        
        // Generate full multi-measure composition
        function generateFullComposition() {
            const totalMeasures = parseInt(document.getElementById('totalMeasures').value);
            const ensemble = document.getElementById('ensemble').value;
            const root = document.getElementById('rootNote').value;
            const quality = document.getElementById('quality').value;
            const tempo = parseInt(document.getElementById('tempo').value);
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value);
            const beatUnit = parseInt(document.getElementById('beatUnit').value);
            
            currentComposition = {
                measures: totalMeasures,
                sections: currentComposition.sections,
                timeSignature: { beats: beatsPerMeasure, beatType: beatUnit },
                tempo: tempo,
                triad: generateTriad(root, quality),
                ensemble: ensemble,
                voices: {}
            };
            
            // Generate voice patterns for each section
            const ensembles = {
                solo: ["primary"],
                quartet: ["violin1", "violin2", "viola", "cello"],
                quintet: ["guitar", "violin1", "violin2", "viola", "cello"]
            };
            
            const voices = ensembles[ensemble];
            
            // Initialize voices with patterns per section
            voices.forEach((voice, index) => {
                currentComposition.voices[voice] = {
                    instrument: voice,
                    measures: []
                };
                
                // Generate patterns for each measure based on sections
                for (let m = 1; m <= totalMeasures; m++) {
                    const section = getSectionForMeasure(m);
                    const ratios = getAvailableRatios(section ? section.complexity : 5);
                    const ratio = ratios[index % ratios.length];
                    
                    currentComposition.voices[voice].measures.push({
                        measureNumber: m,
                        section: section ? section.letter : 'A',
                        tupletRatio: ratio.ratio,
                        notes: generateMeasureNotes(currentComposition.triad, ratio),
                        dynamics: getDynamicForSection(section, index)
                    });
                }
            });
            
            // Update displays
            updateVisualization();
            updateAnalysis();
            updatePatternOutput();
        }
        
        // Get section for a specific measure
        function getSectionForMeasure(measureNum) {
            return currentComposition.sections.find(s => 
                measureNum >= s.startMeasure && measureNum <= s.endMeasure
            );
        }
        
        // Generate notes for a measure
        function generateMeasureNotes(triad, ratio) {
            const notes = [];
            const triadNotes = [triad.root, triad.third, triad.fifth];
            
            for (let i = 0; i < ratio.num; i++) {
                notes.push({
                    pitch: triadNotes[i % 3],
                    octave: 4 + Math.floor(i / 6),
                    duration: ratio.denom / ratio.num,
                    position: i / ratio.num
                });
            }
            
            return notes;
        }
        
        // Get dynamic marking for section
        function getDynamicForSection(section, voiceIndex) {
            if (!section) return 'mf';
            
            const dynamics = {
                1: ['p', 'pp', 'pp', 'ppp', 'ppp'],
                2: ['p', 'p', 'mp', 'p', 'pp'],
                3: ['mp', 'p', 'mp', 'mp', 'p'],
                4: ['mp', 'mp', 'mf', 'mp', 'mp'],
                5: ['mf', 'mp', 'mf', 'mf', 'mp'],
                6: ['mf', 'mf', 'f', 'mf', 'mf'],
                7: ['f', 'mf', 'f', 'f', 'mf'],
                8: ['f', 'f', 'ff', 'f', 'f'],
                9: ['ff', 'f', 'ff', 'ff', 'f'],
                10: ['ff', 'ff', 'fff', 'ff', 'ff']
            };
            
            return dynamics[section.complexity][voiceIndex % 5];
        }
        
        // Generate base triad
        function generateTriad(root, quality) {
            const intervals = {
                major: [0, 4, 7],
                minor: [0, 3, 7],
                diminished: [0, 3, 6],
                augmented: [0, 4, 8],
                suspended2: [0, 2, 7],
                suspended4: [0, 5, 7]
            };
            
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const rootIndex = notes.indexOf(root);
            const pattern = intervals[quality] || intervals.major;
            
            return {
                root: root,
                third: notes[(rootIndex + pattern[1]) % 12],
                fifth: notes[(rootIndex + pattern[2]) % 12],
                quality: quality
            };
        }
        
        // Get available ratios based on complexity
        function getAvailableRatios(complexity) {
            let ratios = [];
            
            if (complexity <= 3) {
                ratios = [...tupletLibrary.simple];
            } else if (complexity <= 6) {
                ratios = [...tupletLibrary.simple, ...tupletLibrary.intermediate];
            } else {
                ratios = [...tupletLibrary.intermediate, ...tupletLibrary.complex];
            }
            
            return ratios.sort((a, b) => a.complexity - b.complexity);
        }
        
        // Update visualization
        function updateVisualization() {
            const visualizer = document.getElementById('visualizer');
            const tracks = document.getElementById('voiceTracks');
            const measureMarkers = document.getElementById('measureMarkers');
            const sectionMarkers = document.getElementById('sectionMarkers');
            
            // Clear existing
            tracks.innerHTML = '';
            measureMarkers.innerHTML = '';
            sectionMarkers.innerHTML = '';
            
            if (!currentComposition.voices || Object.keys(currentComposition.voices).length === 0) return;
            
            // Add measure markers
            const measureWidth = 100 / currentComposition.measures;
            for (let m = 0; m < currentComposition.measures; m++) {
                const marker = document.createElement('div');
                marker.className = 'measure-indicator';
                marker.style.left = `${m * measureWidth}%`;
                measureMarkers.appendChild(marker);
            }
            
            // Add section markers
            currentComposition.sections.forEach(section => {
                const marker = document.createElement('div');
                marker.className = 'section-marker';
                marker.style.left = `${(section.startMeasure - 1) * measureWidth}%`;
                marker.textContent = `Section ${section.letter}`;
                sectionMarkers.appendChild(marker);
            });
            
            // Add voice tracks
            Object.entries(currentComposition.voices).forEach(([voice, data]) => {
                const track = document.createElement('div');
                track.className = 'voice-track';
                track.innerHTML = `
                    <div style="position: absolute; left: 10px; top: 20px; color: #ffd700; z-index: 10;">
                        ${voice}
                    </div>
                `;
                tracks.appendChild(track);
            });
            
            // Update rhythm grid
            updateRhythmGrid();
        }
        
        // Update rhythm grid display
        function updateRhythmGrid() {
            const grid = document.getElementById('rhythmGrid');
            grid.innerHTML = '';
            
            if (!currentComposition.voices || Object.keys(currentComposition.voices).length === 0) return;
            
            // Show current section's rhythms (first section for now)
            const currentSection = currentComposition.sections[0];
            if (!currentSection) return;
            
            Object.entries(currentComposition.voices).forEach(([voice, data]) => {
                const measureData = data.measures.find(m => 
                    m.measureNumber >= currentSection.startMeasure && 
                    m.measureNumber <= currentSection.endMeasure
                );
                
                if (measureData) {
                    const cell = document.createElement('div');
                    cell.className = 'rhythm-cell';
                    cell.innerHTML = `
                        <div class="voice-label">${voice}</div>
                        <div class="tuplet-display">${measureData.tupletRatio}</div>
                        <div style="font-size: 0.9em; color: #adbce6;">${measureData.dynamics}</div>
                    `;
                    grid.appendChild(cell);
                }
            });
        }
        
        // Update analysis
        function updateAnalysis() {
            const display = document.getElementById('analysisDisplay');
            
            if (!currentComposition.voices || Object.keys(currentComposition.voices).length === 0) {
                display.innerHTML = '<div>No composition to analyze</div>';
                return;
            }
            
            const voiceCount = Object.keys(currentComposition.voices).length;
            const measureCount = currentComposition.measures;
            const sectionCount = currentComposition.sections.length;
            
            // Calculate unique rhythms across composition
            const allRatios = new Set();
            Object.values(currentComposition.voices).forEach(voice => {
                voice.measures.forEach(m => allRatios.add(m.tupletRatio));
            });
            
            display.innerHTML = `
                <div class="analysis-item">
                    <div class="analysis-label">Total Measures</div>
                    <div class="analysis-value">${measureCount}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Sections</div>
                    <div class="analysis-value">${sectionCount}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Voice Count</div>
                    <div class="analysis-value">${voiceCount}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Unique Rhythms</div>
                    <div class="analysis-value">${allRatios.size}</div>
                </div>
            `;
        }
        
        // Update pattern output
        function updatePatternOutput() {
            const output = document.getElementById('patternOutput');
            
            if (!currentComposition.voices || Object.keys(currentComposition.voices).length === 0) {
                output.innerHTML = '<pre>No composition generated yet</pre>';
                return;
            }
            
            // Create summary instead of full data dump
            const summary = {
                measures: currentComposition.measures,
                tempo: currentComposition.tempo,
                timeSignature: `${currentComposition.timeSignature.beats}/${currentComposition.timeSignature.beatType}`,
                sections: currentComposition.sections.map(s => ({
                    letter: s.letter,
                    measures: `${s.startMeasure}-${s.endMeasure}`,
                    complexity: s.complexity
                })),
                ensemble: currentComposition.ensemble,
                triad: currentComposition.triad
            };
            
            output.innerHTML = `<pre>${JSON.stringify(summary, null, 2)}</pre>`;
        }
        
        // Export to Sibelius-compliant MusicXML
        function exportSibeliusMusicXML() {
            if (!currentComposition.voices || Object.keys(currentComposition.voices).length === 0) {
                alert('Please generate a composition first');
                return;
            }
            
            const xml = generateEnhancedMusicXML();
            const blob = new Blob([xml], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `polyrhythmic-${currentComposition.triad.root}-${currentComposition.triad.quality}-${currentComposition.measures}measures.musicxml`;
            a.click();
        }
        
        // Generate enhanced MusicXML with multiple measures
        function generateEnhancedMusicXML() {
            const title = `Polyrhythmic Pattern - ${currentComposition.triad.root} ${currentComposition.triad.quality}`;
            
            let xml = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.0">
  <work>
    <work-title>${title}</work-title>
  </work>
  <identification>
    <encoding>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
      <encoder>PolyrhythmicTriadGen v5.0</encoder>
      <software>PolyrhythmicTriadGen v5.0</software>
      <encoding-description>Enhanced Multi-Measure Export</encoding-description>
      <supports element="print" type="yes" value="yes" attribute="new-system"/>
      <supports element="print" type="yes" value="yes" attribute="new-page"/>
      <supports element="accidental" type="yes"/>
      <supports element="beam" type="yes"/>
      <supports element="stem" type="yes"/>
    </encoding>
  </identification>
  <defaults>
    <scaling>
      <millimeters>215.9</millimeters>
      <tenths>1224</tenths>
    </scaling>
    <page-layout>
      <page-height>1584</page-height>
      <page-width>1224</page-width>
      <page-margins type="both">
        <left-margin>85</left-margin>
        <right-margin>85</right-margin>
        <top-margin>85</top-margin>
        <bottom-margin>85</bottom-margin>
      </page-margins>
    </page-layout>
  </defaults>
  <part-list>\n`;
            
            // Add parts to list
            let partIndex = 1;
            for (const voice of Object.keys(currentComposition.voices)) {
                xml += `    <score-part id="P${partIndex}">
      <part-name>${getInstrumentName(voice)}</part-name>
    </score-part>\n`;
                partIndex++;
            }
            
            xml += `  </part-list>\n`;
            
            // Generate parts with all measures
            partIndex = 1;
            for (const [voice, voiceData] of Object.entries(currentComposition.voices)) {
                xml += generateMultiMeasurePart(voice, voiceData, partIndex);
                partIndex++;
            }
            
            xml += '</score-partwise>';
            return xml;
        }
        
        // Generate part with multiple measures
        function generateMultiMeasurePart(voice, voiceData, partIndex) {
            const clef = getClef(voice);
            let xml = `  <part id="P${partIndex}">\n`;
            
            // Generate each measure
            voiceData.measures.forEach((measureData, measureIndex) => {
                const measureNum = measureIndex + 1;
                
                xml += `    <measure number="${measureNum}">\n`;
                
                // Add attributes for first measure
                if (measureNum === 1) {
                    xml += `      <attributes>
        <divisions>256</divisions>
        <key>
          <fifths>0</fifths>
        </key>
        <time>
          <beats>${currentComposition.timeSignature.beats}</beats>
          <beat-type>${currentComposition.timeSignature.beatType}</beat-type>
        </time>
        <clef>
          <sign>${clef.sign}</sign>
          <line>${clef.line}</line>
        </clef>
      </attributes>\n`;
                    
                    // Add tempo marking
                    if (partIndex === 1) {
                        xml += `      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${currentComposition.tempo}</per-minute>
          </metronome>
        </direction-type>
      </direction>\n`;
                    }
                }
                
                // Add rehearsal mark for new sections
                const section = getSectionForMeasure(measureNum);
                if (section && measureNum === section.startMeasure && partIndex === 1) {
                    xml += `      <direction>
        <direction-type>
          <rehearsal>${section.letter}</rehearsal>
        </direction-type>
      </direction>\n`;
                }
                
                // Add dynamics if changed
                xml += `      <direction placement="below">
        <direction-type>
          <dynamics>
            <${measureData.dynamics}/>
          </dynamics>
        </direction-type>
      </direction>\n`;
                
                // Generate notes for this measure
                xml += generateMeasureNotesXML(measureData, voice);
                
                xml += '    </measure>\n';
            });
            
            xml += '  </part>\n';
            return xml;
        }
        
        // Generate notes for a single measure
        function generateMeasureNotesXML(measureData, voice) {
            let xml = '';
            const [num, denom] = measureData.tupletRatio.split(':').map(n => parseInt(n));
            const duration = Math.floor(1024 / num);
            
            measureData.notes.forEach((note, i) => {
                const pitch = getPitchInfo(note.pitch);
                
                xml += `      <note>
        <pitch>
          <step>${pitch.step}</step>${pitch.alter ? `
          <alter>${pitch.alter}</alter>` : ''}
          <octave>${note.octave}</octave>
        </pitch>
        <duration>${duration}</duration>
        <voice>1</voice>
        <type>16th</type>
        <time-modification>
          <actual-notes>${num}</actual-notes>
          <normal-notes>${denom}</normal-notes>
        </time-modification>\n`;
                
                // Add beam
                if (num > 2) {
                    if (i === 0) {
                        xml += '        <beam number="1">begin</beam>\n';
                    } else if (i === measureData.notes.length - 1) {
                        xml += '        <beam number="1">end</beam>\n';
                    } else {
                        xml += '        <beam number="1">continue</beam>\n';
                    }
                }
                
                // Add tuplet brackets
                if (i === 0) {
                    xml += '        <notations>\n';
                    xml += '          <tuplet type="start" bracket="yes" number="1"/>\n';
                    xml += '        </notations>\n';
                } else if (i === measureData.notes.length - 1) {
                    xml += '        <notations>\n';
                    xml += '          <tuplet type="stop" number="1"/>\n';
                    xml += '        </notations>\n';
                }
                
                xml += '      </note>\n';
            });
            
            // Add forward element to fill remaining time if needed
            const totalDuration = duration * num;
            if (totalDuration < 1024) {
                xml += `      <forward>
        <duration>${1024 - totalDuration}</duration>
      </forward>\n`;
            }
            
            return xml;
        }
        
        // Helper functions
        function getInstrumentName(voice) {
            const names = {
                'guitar': 'Jazz Guitar',
                'violin1': 'Violin I',
                'violin2': 'Violin II',
                'viola': 'Viola',
                'cello': 'Violoncello',
                'primary': 'Solo'
            };
            return names[voice] || voice;
        }
        
        function getClef(voice) {
            const clefs = {
                'guitar': { sign: 'G', line: 2 },
                'violin1': { sign: 'G', line: 2 },
                'violin2': { sign: 'G', line: 2 },
                'viola': { sign: 'C', line: 3 },
                'cello': { sign: 'F', line: 4 },
                'primary': { sign: 'G', line: 2 }
            };
            return clefs[voice] || { sign: 'G', line: 2 };
        }
        
        function getPitchInfo(noteName) {
            let step = noteName.replace('#', '').replace('b', '');
            let alter = 0;
            
            if (noteName.includes('#')) {
                alter = 1;
            } else if (noteName.includes('b')) {
                alter = -1;
            }
            
            return { step, alter: alter !== 0 ? alter : null };
        }
        
        // Load preset configurations
        function loadPreset(presetName) {
            const presets = {
                'Minimalist': { complexity: 3, ensemble: 'quartet', measures: 16 },
                'Jazz Fusion': { complexity: 6, ensemble: 'quintet', measures: 8 },
                'Progressive': { complexity: 7, ensemble: 'quintet', measures: 32 },
                'Complex Contemporary': { complexity: 8, ensemble: 'quintet', measures: 24 }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('totalMeasures').value = preset.measures;
                document.getElementById('ensemble').value = preset.ensemble;
                
                // Update first section complexity
                if (currentComposition.sections.length > 0) {
                    currentComposition.sections[0].complexity = preset.complexity;
                }
            }
        }
        
        // Export JSON
        function exportJSON() {
            if (!currentComposition.voices || Object.keys(currentComposition.voices).length === 0) {
                alert('Please generate a composition first');
                return;
            }
            
            const blob = new Blob([JSON.stringify(currentComposition, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'polyrhythmic-composition.json';
            a.click();
        }
    </script>
</body>
</html>