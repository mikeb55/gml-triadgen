<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyrhythmic TriadGen v8.3 - Harmonic Pairs Edition</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .version {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .harmonic-unit {
            border: 3px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            background: linear-gradient(to bottom, #f9f9ff, #fff);
        }
        .harmonic-unit h2 {
            margin-top: 0;
            color: #667eea;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .section h3 {
            color: #4a5568;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .triad-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .triad-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .section-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="number"], select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        #output {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        .rhythm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
            gap: 2px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .beat {
            height: 30px;
            background: #e0e0e0;
            border-radius: 2px;
            transition: background 0.3s;
        }
        .beat.active {
            background: #667eea;
        }
        .voice-leading-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .voice-leading-options label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .progression-display {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
        }
        .harmonic-rhythm-display {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .rhythm-block {
            padding: 5px 10px;
            background: #e0e0e0;
            border-radius: 3px;
            font-size: 12px;
        }
        .rhythm-block.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Polyrhythmic TriadGen ðŸŽµ</h1>
        <div class="version">Version 8.3 - Harmonic Pairs Edition</div>

        <div class="main-grid">
            <!-- Left Hand Unit (Cello + Viola) -->
            <div class="harmonic-unit">
                <h2>Left Hand Unit<br><small>(Cello + Viola)</small></h2>
                
                <!-- Section A - LH -->
                <div class="section">
                    <h3>
                        <input type="checkbox" id="enableLH_A" checked>
                        Section A - Left Hand
                    </h3>
                    <div class="triad-pair">
                        <div class="triad-box">
                            <label>Triad 1 (Root):</label>
                            <select id="rootLH_A1">
                                <option value="C" selected>C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeLH_A1">
                                <option value="major" selected>Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                        <div class="triad-box">
                            <label>Triad 2 (Root):</label>
                            <select id="rootLH_A2">
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F" selected>F</option>
                                <option value="G">G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeLH_A2">
                                <option value="major" selected>Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="section-controls">
                        <div class="control-group">
                            <label>Voice Leading:</label>
                            <select id="voiceLeadingLH_A">
                                <option value="smooth">Smooth</option>
                                <option value="leap">Leap</option>
                                <option value="contrary">Contrary Motion</option>
                                <option value="parallel">Parallel Motion</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Harmonic Rhythm:</label>
                            <select id="harmonicRhythmLH_A">
                                <option value="whole">Whole Note</option>
                                <option value="half" selected>Half Note</option>
                                <option value="quarter">Quarter Note</option>
                                <option value="syncopated">Syncopated</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Polyrhythm:</label>
                            <select id="polyrhythmLH_A">
                                <option value="none">None (Regular)</option>
                                <option value="3:2">3:2</option>
                                <option value="5:4" selected>5:4</option>
                                <option value="7:4">7:4</option>
                                <option value="9:4">9:4</option>
                                <option value="11:4">11:4</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Measures:</label>
                            <input type="number" id="measuresLH_A" min="1" max="8" value="4">
                        </div>
                    </div>
                    <div id="progressionLH_A" class="progression-display"></div>
                </div>

                <!-- Section B - LH -->
                <div class="section">
                    <h3>
                        <input type="checkbox" id="enableLH_B" checked>
                        Section B - Left Hand
                    </h3>
                    <div class="triad-pair">
                        <div class="triad-box">
                            <label>Triad 1 (Root):</label>
                            <select id="rootLH_B1">
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G" selected>G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeLH_B1">
                                <option value="major" selected>Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                        <div class="triad-box">
                            <label>Triad 2 (Root):</label>
                            <select id="rootLH_B2">
                                <option value="C" selected>C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeLH_B2">
                                <option value="major" selected>Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="section-controls">
                        <div class="control-group">
                            <label>Voice Leading:</label>
                            <select id="voiceLeadingLH_B">
                                <option value="smooth" selected>Smooth</option>
                                <option value="leap">Leap</option>
                                <option value="contrary">Contrary Motion</option>
                                <option value="parallel">Parallel Motion</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Harmonic Rhythm:</label>
                            <select id="harmonicRhythmLH_B">
                                <option value="whole">Whole Note</option>
                                <option value="half">Half Note</option>
                                <option value="quarter" selected>Quarter Note</option>
                                <option value="syncopated">Syncopated</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Polyrhythm:</label>
                            <select id="polyrhythmLH_B">
                                <option value="none">None (Regular)</option>
                                <option value="3:2">3:2</option>
                                <option value="5:4">5:4</option>
                                <option value="7:4" selected>7:4</option>
                                <option value="9:4">9:4</option>
                                <option value="11:4">11:4</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Measures:</label>
                            <input type="number" id="measuresLH_B" min="1" max="8" value="4">
                        </div>
                    </div>
                    <div id="progressionLH_B" class="progression-display"></div>
                </div>
            </div>

            <!-- Right Hand Unit (Violins) -->
            <div class="harmonic-unit">
                <h2>Right Hand Unit<br><small>(Violin I + II)</small></h2>
                
                <!-- Section A - RH -->
                <div class="section">
                    <h3>
                        <input type="checkbox" id="enableRH_A" checked>
                        Section A - Right Hand
                    </h3>
                    <div class="triad-pair">
                        <div class="triad-box">
                            <label>Triad 1 (Root):</label>
                            <select id="rootRH_A1">
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E" selected>E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeRH_A1">
                                <option value="major">Major</option>
                                <option value="minor" selected>Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                        <div class="triad-box">
                            <label>Triad 2 (Root):</label>
                            <select id="rootRH_A2">
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="A" selected>A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeRH_A2">
                                <option value="major">Major</option>
                                <option value="minor" selected>Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="section-controls">
                        <div class="control-group">
                            <label>Voice Leading:</label>
                            <select id="voiceLeadingRH_A">
                                <option value="smooth">Smooth</option>
                                <option value="leap">Leap</option>
                                <option value="contrary" selected>Contrary Motion</option>
                                <option value="parallel">Parallel Motion</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Harmonic Rhythm:</label>
                            <select id="harmonicRhythmRH_A">
                                <option value="whole">Whole Note</option>
                                <option value="half" selected>Half Note</option>
                                <option value="quarter">Quarter Note</option>
                                <option value="syncopated">Syncopated</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Polyrhythm:</label>
                            <select id="polyrhythmRH_A">
                                <option value="none">None (Regular)</option>
                                <option value="3:2">3:2</option>
                                <option value="5:4">5:4</option>
                                <option value="7:4" selected>7:4</option>
                                <option value="9:4">9:4</option>
                                <option value="11:4">11:4</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Measures:</label>
                            <input type="number" id="measuresRH_A" min="1" max="8" value="4">
                        </div>
                    </div>
                    <div id="progressionRH_A" class="progression-display"></div>
                </div>

                <!-- Section B - RH -->
                <div class="section">
                    <h3>
                        <input type="checkbox" id="enableRH_B" checked>
                        Section B - Right Hand
                    </h3>
                    <div class="triad-pair">
                        <div class="triad-box">
                            <label>Triad 1 (Root):</label>
                            <select id="rootRH_B1">
                                <option value="C">C</option>
                                <option value="D" selected>D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeRH_B1">
                                <option value="major" selected>Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                        <div class="triad-box">
                            <label>Triad 2 (Root):</label>
                            <select id="rootRH_B2">
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G" selected>G</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <select id="typeRH_B2">
                                <option value="major" selected>Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="section-controls">
                        <div class="control-group">
                            <label>Voice Leading:</label>
                            <select id="voiceLeadingRH_B">
                                <option value="smooth">Smooth</option>
                                <option value="leap" selected>Leap</option>
                                <option value="contrary">Contrary Motion</option>
                                <option value="parallel">Parallel Motion</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Harmonic Rhythm:</label>
                            <select id="harmonicRhythmRH_B">
                                <option value="whole">Whole Note</option>
                                <option value="half">Half Note</option>
                                <option value="quarter">Quarter Note</option>
                                <option value="syncopated" selected>Syncopated</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Polyrhythm:</label>
                            <select id="polyrhythmRH_B">
                                <option value="none">None (Regular)</option>
                                <option value="3:2" selected>3:2</option>
                                <option value="5:4">5:4</option>
                                <option value="7:4">7:4</option>
                                <option value="9:4">9:4</option>
                                <option value="11:4">11:4</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Measures:</label>
                            <input type="number" id="measuresRH_B" min="1" max="8" value="4">
                        </div>
                    </div>
                    <div id="progressionRH_B" class="progression-display"></div>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button onclick="generateComposition()">Generate Composition</button>
            <button onclick="exportMusicXML()">Export MusicXML</button>
            <button onclick="clearOutput()">Clear</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add change listeners to update progression displays
            const sections = ['LH_A', 'LH_B', 'RH_A', 'RH_B'];
            sections.forEach(section => {
                ['1', '2'].forEach(num => {
                    document.getElementById(`root${section}${num}`).addEventListener('change', () => updateProgressionDisplay(section));
                    document.getElementById(`type${section}${num}`).addEventListener('change', () => updateProgressionDisplay(section));
                });
                document.getElementById(`harmonicRhythm${section}`).addEventListener('change', () => updateProgressionDisplay(section));
            });
            
            // Initial display update
            sections.forEach(section => updateProgressionDisplay(section));
        });

        // Triad generation functions
        function generateTriad(root, type) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const rootIndex = notes.indexOf(root);
            
            const intervals = {
                'major': [0, 4, 7],
                'minor': [0, 3, 7],
                'diminished': [0, 3, 6],
                'augmented': [0, 4, 8]
            };
            
            return intervals[type].map(interval => 
                notes[(rootIndex + interval) % 12]
            );
        }

        function updateProgressionDisplay(section) {
            const root1 = document.getElementById(`root${section}1`).value;
            const type1 = document.getElementById(`type${section}1`).value;
            const root2 = document.getElementById(`root${section}2`).value;
            const type2 = document.getElementById(`type${section}2`).value;
            const harmonicRhythm = document.getElementById(`harmonicRhythm${section}`).value;
            
            const triad1 = generateTriad(root1, type1);
            const triad2 = generateTriad(root2, type2);
            
            const display = document.getElementById(`progression${section}`);
            display.innerHTML = `
                <strong>Progression:</strong> ${root1}${type1[0]} (${triad1.join('-')}) â†’ 
                ${root2}${type2[0]} (${triad2.join('-')})
                <br><strong>Harmonic Rhythm:</strong> Changes every ${harmonicRhythm} note
            `;
        }

        function generateRhythmPattern(polyrhythm, measures, harmonicRhythm) {
            const pattern = [];
            const divisions = 256;
            const measureDuration = divisions * 4;
            
            // Determine change points based on harmonic rhythm
            let changeEvery;
            switch(harmonicRhythm) {
                case 'whole': changeEvery = measureDuration; break;
                case 'half': changeEvery = measureDuration / 2; break;
                case 'quarter': changeEvery = measureDuration / 4; break;
                case 'syncopated': changeEvery = measureDuration / 3; break;
            }
            
            if (polyrhythm === 'none') {
                // Regular rhythm based on harmonic rhythm
                const noteValue = harmonicRhythm === 'whole' ? 1024 : 
                                  harmonicRhythm === 'half' ? 512 : 
                                  harmonicRhythm === 'quarter' ? 256 : 341;
                                  
                for (let m = 0; m < measures; m++) {
                    let measureFilled = 0;
                    while (measureFilled < measureDuration) {
                        const duration = Math.min(noteValue, measureDuration - measureFilled);
                        pattern.push({
                            duration: duration,
                            type: duration >= 512 ? 'half' : duration >= 256 ? 'quarter' : 'eighth',
                            changePoint: measureFilled % changeEvery === 0
                        });
                        measureFilled += duration;
                    }
                }
            } else {
                // Polyrhythmic pattern
                const [num, denom] = polyrhythm.split(':').map(Number);
                for (let m = 0; m < measures; m++) {
                    // Two groups per measure (each fills half measure)
                    for (let group = 0; group < 2; group++) {
                        const groupDuration = 512;
                        const baseDuration = Math.floor(groupDuration / num);
                        const remainder = groupDuration - (baseDuration * num);
                        
                        for (let i = 0; i < num; i++) {
                            const extraDuration = i < remainder ? 1 : 0;
                            const currentPosition = m * measureDuration + group * 512 + i * baseDuration;
                            pattern.push({
                                duration: baseDuration + extraDuration,
                                type: 'eighth',
                                tuplet: polyrhythm,
                                actualNotes: num,
                                normalNotes: denom / 2,
                                tupletGroup: m * 2 + group,
                                tupletIndex: i,
                                changePoint: currentPosition % changeEvery === 0
                            });
                        }
                    }
                }
            }
            
            return pattern;
        }

        function applyVoiceLeading(triad1, triad2, voiceLeading) {
            // Apply voice leading rules to smooth transitions
            if (voiceLeading === 'smooth') {
                // Minimize distance between chord tones
                return triad2; // Simplified for now
            } else if (voiceLeading === 'contrary') {
                // Move voices in opposite directions
                return [triad2[2], triad2[0], triad2[1]];
            } else if (voiceLeading === 'parallel') {
                // Keep same intervals
                return triad2;
            } else {
                // Leap - use wider intervals
                return [triad2[1], triad2[2], triad2[0]];
            }
        }

        function generateComposition() {
            const output = document.getElementById('output');
            let composition = {
                leftHand: [],
                rightHand: []
            };
            
            // Process Left Hand sections
            ['A', 'B'].forEach(section => {
                if (document.getElementById(`enableLH_${section}`).checked) {
                    const root1 = document.getElementById(`rootLH_${section}1`).value;
                    const type1 = document.getElementById(`typeLH_${section}1`).value;
                    const root2 = document.getElementById(`rootLH_${section}2`).value;
                    const type2 = document.getElementById(`typeLH_${section}2`).value;
                    const voiceLeading = document.getElementById(`voiceLeadingLH_${section}`).value;
                    const harmonicRhythm = document.getElementById(`harmonicRhythmLH_${section}`).value;
                    const polyrhythm = document.getElementById(`polyrhythmLH_${section}`).value;
                    const measures = parseInt(document.getElementById(`measuresLH_${section}`).value);
                    
                    const triad1 = generateTriad(root1, type1);
                    const triad2 = applyVoiceLeading(triad1, generateTriad(root2, type2), voiceLeading);
                    const pattern = generateRhythmPattern(polyrhythm, measures, harmonicRhythm);
                    
                    composition.leftHand.push({
                        section: section,
                        triads: [triad1, triad2],
                        pattern: pattern,
                        measures: measures,
                        voiceLeading: voiceLeading,
                        harmonicRhythm: harmonicRhythm
                    });
                }
            });
            
            // Process Right Hand sections
            ['A', 'B'].forEach(section => {
                if (document.getElementById(`enableRH_${section}`).checked) {
                    const root1 = document.getElementById(`rootRH_${section}1`).value;
                    const type1 = document.getElementById(`typeRH_${section}1`).value;
                    const root2 = document.getElementById(`rootRH_${section}2`).value;
                    const type2 = document.getElementById(`typeRH_${section}2`).value;
                    const voiceLeading = document.getElementById(`voiceLeadingRH_${section}`).value;
                    const harmonicRhythm = document.getElementById(`harmonicRhythmRH_${section}`).value;
                    const polyrhythm = document.getElementById(`polyrhythmRH_${section}`).value;
                    const measures = parseInt(document.getElementById(`measuresRH_${section}`).value);
                    
                    const triad1 = generateTriad(root1, type1);
                    const triad2 = applyVoiceLeading(triad1, generateTriad(root2, type2), voiceLeading);
                    const pattern = generateRhythmPattern(polyrhythm, measures, harmonicRhythm);
                    
                    composition.rightHand.push({
                        section: section,
                        triads: [triad1, triad2],
                        pattern: pattern,
                        measures: measures,
                        voiceLeading: voiceLeading,
                        harmonicRhythm: harmonicRhythm
                    });
                }
            });
            
            // Store composition globally
            window.currentComposition = composition;
            
            // Display output
            output.textContent = 'Composition Generated!\n\n';
            output.textContent += '=== LEFT HAND (Cello + Viola) ===\n';
            composition.leftHand.forEach(section => {
                output.textContent += `Section ${section.section}: ${section.triads[0].join('-')} â†’ ${section.triads[1].join('-')}\n`;
                output.textContent += `  Voice Leading: ${section.voiceLeading}, Harmonic Rhythm: ${section.harmonicRhythm}\n`;
                output.textContent += `  Pattern: ${section.pattern.length} notes, ${section.measures} measures\n\n`;
            });
            
            output.textContent += '=== RIGHT HAND (Violins) ===\n';
            composition.rightHand.forEach(section => {
                output.textContent += `Section ${section.section}: ${section.triads[0].join('-')} â†’ ${section.triads[1].join('-')}\n`;
                output.textContent += `  Voice Leading: ${section.voiceLeading}, Harmonic Rhythm: ${section.harmonicRhythm}\n`;
                output.textContent += `  Pattern: ${section.pattern.length} notes, ${section.measures} measures\n\n`;
            });
        }

        function exportMusicXML() {
            if (!window.currentComposition) {
                alert('Please generate a composition first!');
                return;
            }
            
            let xml = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
            xml += '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n';
            xml += '<score-partwise version="3.0">\n';
            xml += '  <work><work-title>Harmonic Pairs Composition</work-title></work>\n';
            xml += '  <identification>\n';
            xml += '    <encoding>\n';
            xml += '      <software>TriadGen v8.3</software>\n';
            xml += '      <encoding-date>' + new Date().toISOString().split('T')[0] + '</encoding-date>\n';
            xml += '    </encoding>\n';
            xml += '  </identification>\n';
            
            // Part list - String Quartet
            xml += '  <part-list>\n';
            xml += '    <score-part id="P1"><part-name>Violin I</part-name></score-part>\n';
            xml += '    <score-part id="P2"><part-name>Violin II</part-name></score-part>\n';
            xml += '    <score-part id="P3"><part-name>Viola</part-name></score-part>\n';
            xml += '    <score-part id="P4"><part-name>Violoncello</part-name></score-part>\n';
            xml += '  </part-list>\n';
            
            // Generate parts
            const instruments = [
                {id: 'P1', name: 'Violin I', clef: {sign: 'G', line: 2}, octave: 4, hand: 'right', voice: 0},
                {id: 'P2', name: 'Violin II', clef: {sign: 'G', line: 2}, octave: 4, hand: 'right', voice: 1},
                {id: 'P3', name: 'Viola', clef: {sign: 'C', line: 3}, octave: 3, hand: 'left', voice: 0},
                {id: 'P4', name: 'Cello', clef: {sign: 'F', line: 4}, octave: 2, hand: 'left', voice: 1}
            ];
            
            instruments.forEach(inst => {
                xml += `  <part id="${inst.id}">\n`;
                let measureNum = 1;
                
                const sections = inst.hand === 'left' ? window.currentComposition.leftHand : window.currentComposition.rightHand;
                
                sections.forEach(section => {
                    for (let m = 0; m < section.measures; m++) {
                        xml += `    <measure number="${measureNum}">\n`;
                        
                        if (measureNum === 1) {
                            xml += '      <attributes>\n';
                            xml += '        <divisions>256</divisions>\n';
                            xml += '        <key><fifths>0</fifths></key>\n';
                            xml += '        <time><beats>4</beats><beat-type>4</beat-type></time>\n';
                            xml += `        <clef><sign>${inst.clef.sign}</sign><line>${inst.clef.line}</line></clef>\n`;
                            xml += '      </attributes>\n';
                        }
                        
                        // Add notes for this measure
                        const notesInMeasure = Math.floor(section.pattern.length / section.measures);
                        const startIdx = m * notesInMeasure;
                        let currentTriad = 0;
                        
                        for (let i = startIdx; i < startIdx + notesInMeasure && i < section.pattern.length; i++) {
                            const rhythm = section.pattern[i];
                            
                            // Switch triads at change points
                            if (rhythm.changePoint) {
                                currentTriad = (currentTriad + 1) % 2;
                            }
                            
                            // Select note from current triad based on instrument voice
                            const triad = section.triads[currentTriad];
                            const noteIndex = inst.voice === 0 ? i % 3 : (i + 1) % 3;
                            const note = triad[noteIndex];
                            
                            xml += '      <note>\n';
                            xml += '        <pitch>\n';
                            xml += `          <step>${note.replace('#', '')}</step>\n`;
                            if (note.includes('#')) {
                                xml += '          <alter>1</alter>\n';
                            }
                            xml += `          <octave>${inst.octave}</octave>\n`;
                            xml += '        </pitch>\n';
                            xml += `        <duration>${rhythm.duration}</duration>\n`;
                            xml += '        <voice>1</voice>\n';
                            xml += `        <type>${rhythm.type}</type>\n`;
                            
                            if (rhythm.tuplet) {
                                xml += '        <time-modification>\n';
                                xml += `          <actual-notes>${rhythm.actualNotes}</actual-notes>\n`;
                                xml += `          <normal-notes>${rhythm.normalNotes}</normal-notes>\n`;
                                xml += '        </time-modification>\n';
                            }
                            
                            xml += '      </note>\n';
                        }
                        
                        xml += '    </measure>\n';
                        measureNum++;
                    }
                });
                
                xml += `  </part>\n`;
            });
            
            xml += '</score-partwise>\n';
            
            // Download the file
            const blob = new Blob([xml], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'harmonic_pairs_v8.3.musicxml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
            window.currentComposition = null;
        }
    </script>
</body>
</html>